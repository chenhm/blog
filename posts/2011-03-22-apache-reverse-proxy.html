<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, user-scalable=no">
    <meta name="renderer" content="webkit">
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="/manifest.json">
    <link href="/static/asciidoctor.min.css" rel="stylesheet"/>
    <link href="/static/build.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/themes/prism.min.css" integrity="sha256-77qGXu2p8NpfcBpTjw4jsMeQnz0vyh74f5do0cWjQ/Q=" crossorigin="anonymous" />
</head>
<body>
<div id='app'>
    <header class="header">
        <div class="container">
            <!--start: Navigation -->
            <a href="/" class="brand">On the Road</a>
<!--            <ul class="nav">-->
<!--                <li><a href="/list/">Blogs</a></li>-->
<!--                <li><a href="/slides/">Slides</a></li>-->
<!--                <li><a href="/about/">About</a></li>-->
<!--            </ul>-->
        </div>
        <!--end: Navigation -->
        <div style="clear: both"></div>
        <search-bar v-if="isPageList"></search-bar>
    </header>

<section class="post-view">
    <article>
     
         <h1 class="post-title">             Apache2.2 HTTPS反向代理配置         </h1>
     
     <h2 id="第一步建立一个-ca-的证书" class="md">第一步：建立一个 CA 的证书</h2>
<p>首先为 CA 创建一个 RSA 私用密钥，<br />
[S-1] <code>openssl genrsa -des3 -out ca.key 1024</code> (由于windows系统下的ssl_module不支持加密密钥，使用opensslgenrsa -out ca.key 1024) 系统提示输入 PEM pass phrase，也就是密码，输入后牢记它。 生成 ca.key 文件，将文件属性改为400，并放在安全的地方。<br />
[S-2] <code>chmod 400 ca.key</code><br />
你可以用下列命令查看它的内容，<br />
[S-3] <code>openssl rsa -noout -text -in ca.key</code></p>
<p>利用 CA 的 RSA 密钥创建一个自签署的 CA 证书（X.509结构）<br />
[S-4] <code>openssl req -new -x509 -days 3650-key ca.key -out ca.crt</code> 然后需要输入下列信息：</p>
<pre><code>Country Name: CN 两个字母的国家代号
State or Province Name: Guangdong 省份名称
Locality Name: Guangzhou 城市名称
Organization Name: 公司名称
Organizational Unit Name:  部门名称
Common Name:  你的姓名
Email Address:  Email地址
</code></pre>
<p>生成 ca.crt 文件，将文件属性改为400，并放在安全的地方。<br />
[S-5] <code>chmod 400 ca.crt</code><br />
你可以用下列命令查看它的内容，<br />
[S-6] <code>openssl x509 -noout -text -in ca.crt</code></p>
<h2 id="第二步创建服务器证书签署请求" class="md">第二步：创建服务器证书签署请求</h2>
<p>首先为你的 Apache 创建一个 RSA 私用密钥:<br />
[S-7] <code>openssl genrsa -des3 -out server.key1024</code> (同上windows下使用opensslgenrsa -out server.key 1024) 这里也要设定pass phrase。<br />
生成 server.key 文件，将文件属性改为400，并放在安全的地方。<br />
[S-8] <code>chmod 400 server.key</code><br />
你可以用下列命令查看它的内容，<br />
[S-9] <code>openssl rsa -noout -text -inserver.key</code></p>
<p>用 server.key 生成证书签署请求 CSR.<br />
[S-10] <code>openssl req -new -key server.key-out server.csr</code> 这里也要输入一些信息，和[S-4]中的内容类似。 至于 'extra' attributes 不用输入。 “Common Name: Chen HM 你的姓名”这条信息请你输入你的服务器的域名或者IP地址， 你可以查看 CSR 的细节<br />
[S-11] <code>openssl req -noout -text -inserver.csr</code></p>
<h2 id="第三步签署证书" class="md">第三步：签署证书</h2>
<p>需要用到脚本 sign.sh<br />
[S-12] <code>./sign.sh server.csr</code> 就可以得到server.crt。 如果没有sign.sh也可以用以下命令签名<br />
<code>openssl ca -config openssl.cnf -days 3650-cert ca.crt -keyfile ca.key -in server.csr -out server.crt</code><br />
注意需要手动创建一个CA目录结构</p>
<pre><code>└─ssl
	├─newcerts
	├─index.txt
	├─serial
</code></pre>
<p>在demoCA中建立 index.txt 空文件, serial文件 , serial文件中可输入01 否则运行这个命令会出错：I am unable to access the ./demoCA/newcerts directory....</p>
<p>将文件属性改为400，并放在安全的地方。<br />
[S-13] <code>chmod 400 server.crt</code><br />
删除CSR<br />
[S-14] <code>rm server.csr</code></p>
<h2 id="最后apache设置" class="md">最后apache设置</h2>
<p>修改httpd.conf<br />
去掉Include conf/extra/httpd-ssl.conf 这一行的注释<br />
修改httpd-ssl.conf<br />
在<VirtualHost>中增加以下内容</p>
<pre><code class="language-xml">&lt;VirtualHost&gt;
# 原有内容保留，增加以下内容
# 声明ssl代理引擎
SSLProxyEngine on
# 这里声明代理的URL转换处理
# 注意需要使用域名，否则证书、用户页面的URL会有问题
	ProxyPass / https://yourdomain:443/
	ProxyPassReverse / https:// yourdomain:443/
&lt;/VirtualHost&gt;
</code></pre>
<p>sign.sh的内容如下：</p>
<pre><code class="language-bash">#!/bin/sh
##
##  sign.sh -- Sign a SSL Certificate Request (CSR)
##  Copyright (c) 1998-2001 Ralf S. Engelschall, All Rights Reserved. 
##

#   argument line handling
CSR=$1
if[$#-ne1]; then
echo&quot;Usage: sign.sign &lt;whatever&gt;;.csr&quot;; exit1
fi
if[!-f$CSR]; then
echo&quot;CSR not found: $CSR&quot;; exit1
fi
case$CSRin
*.csr )CERT=&quot;`echo $CSR | sed -e 's/\.csr/.crt/'`&quot;;;
*)CERT=&quot;$CSR.crt&quot;;;
esac

#   make sure environment exists
if[!-d ca.db.certs ]; then
mkdir ca.db.certs
fi
if[!-f ca.db.serial ]; then
echo'01'&gt; ca.db.serial
fi
if[!-f ca.db.index ]; then
cp/dev/null ca.db.index
fi

#   create an own SSLeay config
cat&gt; ca.config &lt;&lt;EOT
[ ca ]
default_ca              = CA_own
[ CA_own ]
dir                     = .
certs                   = \$dir
new_certs_dir           = \$dir/ca.db.certs
database                = \$dir/ca.db.index
serial                  = \$dir/ca.db.serial
RANDFILE                = \$dir/ca.db.rand
certificate             = \$dir/ca.crt
private_key             = \$dir/ca.key
default_days            = 365
default_crl_days        = 30
default_md              = md5
preserve                = no
policy                  = policy_anything
[ policy_anything ]
countryName             = optional
stateOrProvinceName     = optional
localityName            = optional
organizationName        = optional
organizationalUnitName  = optional
commonName              = supplied
emailAddress            = optional
EOT

#  sign the certificate
echo&quot;CA signing: $CSR -&gt; $CERT:&quot;
../bin/openssl ca -config ca.config -out$CERT-infiles$CSR
echo&quot;CA verifying: $CERT &lt;-&gt; CA cert&quot;
../bin/openssl verify -CAfile  ca.crt  $CERT

#  cleanup after SSLeay 
rm-f ca.config
rm-f ca.db.serial.old
rm-f ca.db.index.old

#  die gracefully
exit0
</code></pre>

    </article>
    <section class="comment">
        <div id="disqus_thread"></div>
    </section>
</section>
<footer class="footer">
    Copyright © 2020 | Powered by <a href="https://github.com/chenhm/java-static-blog" target="_blank">java-static-blog</a>
</footer>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-core.min.js" integrity="sha256-Y+Budm2wBEjYjbH0qcJRmLuRBFpXd0VKxl6XhdS4hgA=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/plugins/autoloader/prism-autoloader.min.js" integrity="sha256-ht8ay6ZTPZfuixYB99I5oRpCLsCq7Do2LjEYLwbe+X8=" crossorigin="anonymous"></script>
</body>
</html>