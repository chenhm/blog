<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>Netty 简介</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, user-scalable=no"/>
    <meta name="renderer" content="webkit"/>
    <meta name="theme-color" content="#ffffff"/>
    <link rel="manifest" href="/manifest.json"/>
    <link rel="icon" type="image/png" href="/static/icon.png"/>
    <link href="/static/asciidoctor.min.css" rel="stylesheet"/>
    <link href="/static/build.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/themes/prism.min.css" integrity="sha256-77qGXu2p8NpfcBpTjw4jsMeQnz0vyh74f5do0cWjQ/Q=" crossorigin="anonymous" />
</head>
<body>
<div id='app'>
    <header class="header">
        <div class="container">
            <!--start: Navigation -->
            <a href="/" class="brand">On the Road</a>
<!--            <ul class="nav">-->
<!--                <li><a href="/list/">Blogs</a></li>-->
<!--                <li><a href="/slides/">Slides</a></li>-->
<!--                <li><a href="/about/">About</a></li>-->
<!--            </ul>-->
        </div>
        <!--end: Navigation -->
        <div style="clear: both"></div>
        <search-bar v-if="isPageList"></search-bar>
    </header>

<section class="post-view">
    <article>
     
     <h1>Netty 简介</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_核心概念">1. 核心概念</a>
<ul class="sectlevel2">
<li><a href="#_channel">1.1. Channel</a></li>
<li><a href="#_channel_pipeline">1.2. Channel Pipeline</a></li>
<li><a href="#_events_handlers">1.3. Events &amp; Handlers</a></li>
<li><a href="#_encoders_decoders">1.4. Encoders &amp; Decoders</a></li>
<li><a href="#_future">1.5. Future</a></li>
</ul>
</li>
<li><a href="#_服务端应用">2. 服务端应用</a>
<ul class="sectlevel2">
<li><a href="#_server初始化">2.1. Server初始化</a></li>
<li><a href="#_消息编码与解码">2.2. 消息编码与解码</a></li>
<li><a href="#_异常处理">2.3. 异常处理</a></li>
</ul>
</li>
<li><a href="#_客户端应用">3. 客户端应用</a>
<ul class="sectlevel2">
<li><a href="#_client初始化">3.1. Client初始化</a></li>
<li><a href="#_事件处理">3.2. 事件处理</a></li>
</ul>
</li>
<li><a href="#_内部机制">4. 内部机制</a>
<ul class="sectlevel2">
<li><a href="#_线程模型">4.1. 线程模型</a></li>
<li><a href="#_bytebuf">4.2. ByteBuf</a></li>
<li><a href="#_native_epoll">4.3. Native epoll</a></li>
</ul>
</li>
<li><a href="#_参考">参考</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://chenhm.com">Chen Hongming</a></p>
</div>
<div class="paragraph">
<p>Netty 是个高性能NIO框架，它通过事件处理模型，隐藏了异步处理的细节，使我们在应用层仅需要关注消息对象的处理，而不用关心调度过程。同时 Netty 提供了很多协议栈的实现，大大简化了网络相关应用的开发难度。本文是Netty的入门指南，着重在讲清Netty和异步网络接口的基本概念，避免入坑。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Netty 当前稳定版是 4.x，而 5.x 是个废弃的版本。 <a href="https://github.com/netty/netty/issues/4466">作者说明</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_核心概念">1. 核心概念</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_channel">1.1. Channel</h3>
<div class="paragraph">
<p>Channel代表一条传输链路，其底层可以是各种传输层协议，UDP、TCP、SCTP等等，可以在channel上进行读写操作。</p>
</div>
</div>
<div class="sect2">
<h3 id="_channel_pipeline">1.2. Channel Pipeline</h3>
<div class="paragraph">
<p>Netty认为数据流可以被多个 Handler 链式处理，每个 handler 接受前一个 handler 处理的结果，并输出给下个 handler，这个流程关系就是 pipeline。</p>
</div>
<div class="paragraph">
<p>例如我们处理HTTPS请求的过程大致如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>将加密数据解码为字节流</p>
</li>
<li>
<p>对字节流解析出http消息</p>
</li>
<li>
<p>如果是chunked类型的http消息，我们可以做一次聚合</p>
</li>
<li>
<p>业务处理并返回response对象</p>
</li>
<li>
<p>将返回对象序列化为字节流</p>
</li>
<li>
<p>SSL加密后返回给客户端</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U2NyaXB0VHlwZT0iYXBwbGljYXRpb24vZWNtYXNjcmlwdCIgY29udGVudFN0eWxlVHlwZT0idGV4dC9jc3MiIGhlaWdodD0iMjYwcHgiIHByZXNlcnZlQXNwZWN0UmF0aW89Im5vbmUiIHN0eWxlPSJ3aWR0aDoxMDMwcHg7aGVpZ2h0OjI2MHB4OyIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgMTAzMCAyNjAiIHdpZHRoPSIxMDMwcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+PCFbQ0RBVEFbdGV4dHtmb250LWZhbWlseTpLYWlHZW4gR290aGljIENOLE1pY3Jvc29mdCBZYUhlaSxBcmlhbCxzYW5zLXNlcmlmfV1dPjwvc3R5bGU+PGRlZnMvPjxnPjwhLS1NRDU9W2RmMGI0OWIzYmNlYTRhMTAzNGU3ZTU2YTk2MDhiNDcxXQpjbHVzdGVyIENoYW5uZWwtLT48cG9seWdvbiBmaWxsPSIjRjVGMkYwIiBwb2ludHM9IjE5MywyNCwxOTMsMjQuMjEwMiwyMDIuOTUxOCwyMy41ODU3LDIxMi45MDM2LDI0LjE5MzMsMjIyLjg1NTQsMjQuMzk5NywyMzIuODA3MiwyMy4yODY2LDI0Mi43NTksMjMuOTIyMywyNTIuNzEwOCwyMy41NzM1LDI2Mi42NjI3LDIzLjYxNjUsMjcyLjYxNDUsMjMuOTMxOCwyODIuNTY2MywyMy4zMDg2LDI5Mi41MTgxLDI0LjU1MzYsMzAyLjQ2OTksMjMuMzY5NywzMTIuNDIxNywyMy44MDIyLDMyMi4zNzM1LDI0LjQzMTksMzMyLjMyNTMsMjMuOTE0MiwzNDIuMjc3MSwyNC4wNjgyLDM1Mi4yMjg5LDIzLjk2ODEsMzYyLjE4MDcsMjQuMTc4NSwzNzIuMTMyNSwyNC4yMzkxLDM4Mi4wODQzLDI0LjU4NTcsMzkyLjAzNjEsMjQuNjcxMSw0MDEuOTg4LDI0LjY3OTMsNDExLjkzOTgsMjQuMjU0Niw0MjEuODkxNiwyNC40NjM2LDQzMS44NDM0LDI0LjcwMjIsNDQxLjc5NTIsMjMuMjc4OCw0NTEuNzQ3LDI0LjY3ODUsNDYxLjY5ODgsMjMuNzAzNSw0NzEuNjUwNiwyNC41MzM4LDQ4MS42MDI0LDIzLjUwNSw0OTEuNTU0MiwyMy45MzE1LDUwMS41MDYsMjQuNzQxNiw1MTEuNDU3OCwyMy45NTEzLDUyMS40MDk2LDI0LjEwNTMsNTMxLjM2MTQsMjQuMzM4Niw1NDEuMzEzMywyNC40MTYyLDU1MS4yNjUxLDIzLjk5NjEsNTYxLjIxNjksMjQuMjg3Miw1NzEuMTY4NywyMy40Mjc2LDU4MS4xMjA1LDI0LjI4NDQsNTkxLjA3MjMsMjQuNTQ4Miw2MDEuMDI0MSwyNC40NDQ1LDYxMC45NzU5LDI0LjYxMyw2MjAuOTI3NywyMy41MTY5LDYzMC44Nzk1LDIzLjM0NzgsNjQwLjgzMTMsMjMuMzc4Niw2NTAuNzgzMSwyMy45NDExLDY2MC43MzQ5LDIzLjgwMzUsNjcwLjY4NjcsMjQuNjgxNCw2ODAuNjM4NiwyMy44MjUzLDY5MC41OTA0LDIzLjY1NjksNzAwLjU0MjIsMjQuMjI4Myw3MTAuNDk0LDIzLjMzMzIsNzIwLjQ0NTgsMjMuNDgwOSw3MzAuMzk3NiwyNC42NDksNzQwLjM0OTQsMjQuNDM1Nyw3NTAuMzAxMiwyNC43MzQ1LDc2MC4yNTMsMjMuNjc4Miw3NzAuMjA0OCwyNC4zMTkyLDc4MC4xNTY2LDI0LjU5MDQsNzkwLjEwODQsMjMuNTI3Niw4MDAuMDYwMiwyMy45MDQxLDgxMC4wMTIsMjQuMTI2LDgxOS45NjM5LDI0LjY1MTgsODI5LjkxNTcsMjMuOTk1OCw4MzkuODY3NSwyNC40NjI2LDg0OS44MTkzLDIzLjQ0NjIsODU5Ljc3MTEsMjMuMzIyNyw4NjkuNzIyOSwyNC41MDM2LDg3OS42NzQ3LDIzLjI4MzEsODg5LjYyNjUsMjQuNTA5LDg5OS41NzgzLDI0LjIwNjYsOTA5LjUzMDEsMjMuNzMyMSw5MTkuNDgxOSwyMy42NDYyLDkyOS40MzM3LDI0LjQ1ODgsOTM5LjM4NTUsMjMuNzAwNyw5NDkuMzM3MywyNC41OTE5LDk1OS4yODkyLDIzLjQ0NzMsOTY5LjI0MSwyNC42MTc0LDk3OS4xOTI4LDI0LjQ4NDMsOTg5LjE0NDYsMjQuMjQ1LDk5OS4wOTY0LDI0LjA0NzIsMTAwOS4wNDgyLDI0LjcyNjYsMTAxOSwyNCwxMDE5LjYxMzYsMjQsMTAxOS4xNjkzLDMzLjc4MjYsMTAxOS4yNjgyLDQzLjU2NTIsMTAxOC44Njk3LDUzLjM0NzgsMTAxOS43MTY1LDYzLjEzMDQsMTAxOS4xNTQ5LDcyLjkxMywxMDE5LjE3MjYsODIuNjk1NywxMDE4LjM5MTYsOTIuNDc4MywxMDE4LjU5NDgsMTAyLjI2MDksMTAxOS41MzA3LDExMi4wNDM1LDEwMTkuNDI5OCwxMjEuODI2MSwxMDE4Ljk1NzEsMTMxLjYwODcsMTAxOC42Nzc4LDE0MS4zOTEzLDEwMTguNzgxMSwxNTEuMTczOSwxMDE4LjMxMzgsMTYwLjk1NjUsMTAxOS40MTQ3LDE3MC43MzkxLDEwMTkuNzM5NiwxODAuNTIxNywxMDE5LjUyNjQsMTkwLjMwNDMsMTAxOS42OTQ5LDIwMC4wODcsMTAxOC44NjMzLDIwOS44Njk2LDEwMTkuMDg3MiwyMTkuNjUyMiwxMDE4LjYxMjQsMjI5LjQzNDgsMTAxOS4yODQsMjM5LjIxNzQsMTAxOSwyNDksMTAxOSwyNDkuMjQ2OCwxMDA5LjA0ODIsMjQ5LjU1MjQsOTk5LjA5NjQsMjQ4Ljc3MDMsOTg5LjE0NDYsMjQ4Ljg2NTYsOTc5LjE5MjgsMjQ5LjQ0MzUsOTY5LjI0MSwyNDkuNTY3Myw5NTkuMjg5MiwyNDguNDg3NSw5NDkuMzM3MywyNDguODA2MSw5MzkuMzg1NSwyNDkuMTQ5Myw5MjkuNDMzNywyNDguMzg5Miw5MTkuNDgxOSwyNDkuMzUzNCw5MDkuNTMwMSwyNDkuMjU4LDg5OS41NzgzLDI0OC44OTkyLDg4OS42MjY1LDI0OS4xNDIyLDg3OS42NzQ3LDI0OS43Mjg3LDg2OS43MjI5LDI0OC42ODcxLDg1OS43NzExLDI0OS4zMTUsODQ5LjgxOTMsMjQ5LjI4NTYsODM5Ljg2NzUsMjQ5LjExNTgsODI5LjkxNTcsMjQ5LjE0MDksODE5Ljk2MzksMjQ5LjExMzUsODEwLjAxMiwyNDguMzc1OCw4MDAuMDYwMiwyNDguNTk5Miw3OTAuMTA4NCwyNDguNTM4NSw3ODAuMTU2NiwyNDkuMDYzOCw3NzAuMjA0OCwyNDkuMDg4MSw3NjAuMjUzLDI0OS4xNjE3LDc1MC4zMDEyLDI0OC43MDksNzQwLjM0OTQsMjQ4LjkzMjUsNzMwLjM5NzYsMjQ4Ljg3OTgsNzIwLjQ0NTgsMjQ5LjU3NjksNzEwLjQ5NCwyNDkuNDI2Niw3MDAuNTQyMiwyNDguNTE0NSw2OTAuNTkwNCwyNDguOTI3MSw2ODAuNjM4NiwyNDguNDIyOCw2NzAuNjg2NywyNDkuMjg4NCw2NjAuNzM0OSwyNDkuNjA4NSw2NTAuNzgzMSwyNDkuNTQ0Niw2NDAuODMxMywyNDguNTY0NCw2MzAuODc5NSwyNDkuNDY0LDYyMC45Mjc3LDI0OC4yNTcyLDYxMC45NzU5LDI0OS4yMDAyLDYwMS4wMjQxLDI0OC43MDA3LDU5MS4wNzIzLDI0OS4wOTY3LDU4MS4xMjA1LDI0OS4yNDAzLDU3MS4xNjg3LDI0OS40NzIxLDU2MS4yMTY5LDI0OC4yODAxLDU1MS4yNjUxLDI0OS40NzU1LDU0MS4zMTMzLDI0OS4xNzgyLDUzMS4zNjE0LDI0OS4zNTUzLDUyMS40MDk2LDI0OS43NDc4LDUxMS40NTc4LDI0OS4wMDU1LDUwMS41MDYsMjQ5LjE3NTMsNDkxLjU1NDIsMjQ5LjIxMzQsNDgxLjYwMjQsMjQ5LjE5NzIsNDcxLjY1MDYsMjQ4Ljk5OTIsNDYxLjY5ODgsMjQ5LjcxMDcsNDUxLjc0NywyNDguMzkwMyw0NDEuNzk1MiwyNDkuNTY1Myw0MzEuODQzNCwyNDguMzc2LDQyMS44OTE2LDI0OC40NTk3LDQxMS45Mzk4LDI0OS4wNCw0MDEuOTg4LDI0OS4wMjgzLDM5Mi4wMzYxLDI0OC41MDcyLDM4Mi4wODQzLDI0OS40MTM3LDM3Mi4xMzI1LDI0OS4xMDg5LDM2Mi4xODA3LDI0OS43MjY3LDM1Mi4yMjg5LDI0OS42NjcxLDM0Mi4yNzcxLDI0OC41NTE3LDMzMi4zMjUzLDI0OC42MDIxLDMyMi4zNzM1LDI0OC44NzA4LDMxMi40MjE3LDI0OS4zNTU1LDMwMi40Njk5LDI0OS40MDMsMjkyLjUxODEsMjQ5LjMwMTIsMjgyLjU2NjMsMjQ4LjY1OCwyNzIuNjE0NSwyNDkuNjM2NCwyNjIuNjYyNywyNDkuNjMzOCwyNTIuNzEwOCwyNDguOTUyNywyNDIuNzU5LDI0OC43NjA5LDIzMi44MDcyLDI0OC41OTg2LDIyMi44NTU0LDI0OC43ODU0LDIxMi45MDM2LDI0OS4xMzc0LDIwMi45NTE4LDI0OC45MzE2LDE5MywyNDksMTkyLjU4MjIsMjQ5LDE5My40ODc0LDIzOS4yMTc0LDE5Mi41NDExLDIyOS40MzQ4LDE5My41MDI0LDIxOS42NTIyLDE5My40MjcyLDIwOS44Njk2LDE5My4zNzE5LDIwMC4wODcsMTkzLjY5MjUsMTkwLjMwNDMsMTkyLjc1NDEsMTgwLjUyMTcsMTkyLjY5OTQsMTcwLjczOTEsMTkzLjUxODksMTYwLjk1NjUsMTkyLjQwMzEsMTUxLjE3MzksMTkyLjc2NiwxNDEuMzkxMywxOTMuMTE1NSwxMzEuNjA4NywxOTMuMDY4NywxMjEuODI2MSwxOTIuNjQxNSwxMTIuMDQzNSwxOTIuOTU3LDEwMi4yNjA5LDE5My43NDQ2LDkyLjQ3ODMsMTkzLjY0ODUsODIuNjk1NywxOTIuNDAzNyw3Mi45MTMsMTkzLjA3ODUsNjMuMTMwNCwxOTIuNDg2MSw1My4zNDc4LDE5Mi45NzM3LDQzLjU2NTIsMTkzLjI5MywzMy43ODI2LDE5MywyNCIgc3R5bGU9InN0cm9rZTogI0NDQ0NDQzsgc3Ryb2tlLXdpZHRoOiAxLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iNjQiIHg9IjU3NCIgeT0iMzguOTk1MSI+Q2hhbm5lbDwvdGV4dD48IS0tTUQ1PVsyYjgxMzM4N2FjMWE5YWYwOWZhM2U2Mzk5ZTBmZTg2Y10KZW50aXR5IHNzbC0tPjxwb2x5Z29uIGZpbGw9IiNERkYwRDgiIHBvaW50cz0iMjA5LDEyMy41LDIwOSwxMjMuNzEwMiwyMTkuNDI4NiwxMjMuMDg1NywyMjkuODU3MSwxMjMuNjkzMywyNDAuMjg1NywxMjMuODk5NywyNTAuNzE0MywxMjIuNzg2NiwyNjEuMTQyOSwxMjMuNDIyMywyNzEuNTcxNCwxMjMuMDczNSwyODIsMTIzLjUsMjgxLjYxNjUsMTIzLjUsMjgxLjkzMTgsMTMyLjk2NTMsMjgxLjMwODYsMTQyLjQzMDYsMjgyLjU1MzYsMTUxLjg5NTgsMjgxLjM2OTcsMTYxLjM2MTEsMjgxLjgwMjIsMTcwLjgyNjQsMjgyLjQzMTksMTgwLjI5MTcsMjgxLjkxNDIsMTg5Ljc1NjksMjgyLjA2ODIsMTk5LjIyMjIsMjgyLDIwOC42ODc1LDI4MiwyMDguNjU1NiwyNzEuNTcxNCwyMDguODY2LDI2MS4xNDI5LDIwOC45MjY2LDI1MC43MTQzLDIwOS4yNzMyLDI0MC4yODU3LDIwOS4zNTg2LDIyOS44NTcxLDIwOS4zNjY4LDIxOS40Mjg2LDIwOC45NDIxLDIwOSwyMDguNjg3NSwyMDkuNDYzNiwyMDguNjg3NSwyMDkuNzAyMiwxOTkuMjIyMiwyMDguMjc4OCwxODkuNzU2OSwyMDkuNjc4NSwxODAuMjkxNywyMDguNzAzNSwxNzAuODI2NCwyMDkuNTMzOCwxNjEuMzYxMSwyMDguNTA1LDE1MS44OTU4LDIwOC45MzE1LDE0Mi40MzA2LDIwOS43NDE2LDEzMi45NjUzLDIwOSwxMjMuNSIgc3R5bGU9InN0cm9rZTogIzQ2ODg0Nzsgc3Ryb2tlLXdpZHRoOiAxLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nQW5kR2x5cGhzIiB0ZXh0TGVuZ3RoPSIwIiB4PSIyNDcuNSIgeT0iMTQ2LjQ5NTEiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmdBbmRHbHlwaHMiIHRleHRMZW5ndGg9IjI1IiB4PSIyMzMiIHk9IjE2Mi43OTIiPlNTTDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmdBbmRHbHlwaHMiIHRleHRMZW5ndGg9IjUzIiB4PSIyMTkiIHk9IjE3OS4wODg5Ij5IYW5kbGVyPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iMCIgeD0iMjQ3LjUiIHk9IjE5NS4zODU3Ii8+PCEtLU1ENT1bMWExZjcyNzkwOGE1MDEyNzU5MDU2NTBlZmU1MzljOTVdCmVudGl0eSBkZWNvZGVyLS0+PHBvbHlnb24gZmlsbD0iI0RGRjBEOCIgcG9pbnRzPSIzOTUsNTkuNSwzOTUsNTkuNzEwMiw0MDUsNTkuMDg1Nyw0MTUsNTkuNjkzMyw0MjUsNTkuODk5Nyw0MzUsNTguNzg2Niw0NDUsNTkuNDIyMyw0NTUsNTkuMDczNSw0NjUsNTkuMTE2NSw0NzUsNTkuNSw0NzQuOTMxOCw1OS41LDQ3NC4zMDg2LDcwLjAxODgsNDc1LjU1MzYsODAuNTM3NSw0NzQuMzY5Nyw5MS4wNTYzLDQ3NC44MDIyLDEwMS41NzUsNDc1LDExMi4wOTM4LDQ3NSwxMTIuNTI1Nyw0NjUsMTEyLjAwOCw0NTUsMTEyLjE2Miw0NDUsMTEyLjA2MTgsNDM1LDExMi4yNzIzLDQyNSwxMTIuMzMyOSw0MTUsMTEyLjY3OTQsNDA1LDExMi43NjQ4LDM5NSwxMTIuMDkzOCwzOTUuNjc5MywxMTIuMDkzOCwzOTUuMjU0NiwxMDEuNTc1LDM5NS40NjM2LDkxLjA1NjMsMzk1LjcwMjIsODAuNTM3NSwzOTQuMjc4OCw3MC4wMTg4LDM5NSw1OS41IiBzdHlsZT0ic3Ryb2tlOiAjNDY4ODQ3OyBzdHJva2Utd2lkdGg6IDEuNTsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmdBbmRHbHlwaHMiIHRleHRMZW5ndGg9IjM3IiB4PSI0MTYuNSIgeT0iODIuNDk1MSI+SFRUUDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmdBbmRHbHlwaHMiIHRleHRMZW5ndGg9IjYwIiB4PSI0MDUiIHk9Ijk4Ljc5MiI+RGVjb2RlcjwvdGV4dD48IS0tTUQ1PVs5NWFlYTBhNTNlZmI2MThmYzU2OWVjZTExOTc3ODFkZl0KZW50aXR5IGVuY29kZXItLT48cG9seWdvbiBmaWxsPSIjREZGMEQ4IiBwb2ludHM9IjM5NiwxNzkuNSwzOTYsMTc5LjcxMDIsNDA1Ljc1LDE3OS4wODU3LDQxNS41LDE3OS42OTMzLDQyNS4yNSwxNzkuODk5Nyw0MzUsMTc4Ljc4NjYsNDQ0Ljc1LDE3OS40MjIzLDQ1NC41LDE3OS4wNzM1LDQ2NC4yNSwxNzkuMTE2NSw0NzQsMTc5LjUsNDczLjkzMTgsMTc5LjUsNDczLjMwODYsMTkwLjAxODgsNDc0LjU1MzYsMjAwLjUzNzUsNDczLjM2OTcsMjExLjA1NjMsNDczLjgwMjIsMjIxLjU3NSw0NzQsMjMyLjA5MzgsNDc0LDIzMi41MjU3LDQ2NC4yNSwyMzIuMDA4LDQ1NC41LDIzMi4xNjIsNDQ0Ljc1LDIzMi4wNjE4LDQzNSwyMzIuMjcyMyw0MjUuMjUsMjMyLjMzMjksNDE1LjUsMjMyLjY3OTQsNDA1Ljc1LDIzMi43NjQ4LDM5NiwyMzIuMDkzOCwzOTYuNjc5MywyMzIuMDkzOCwzOTYuMjU0NiwyMjEuNTc1LDM5Ni40NjM2LDIxMS4wNTYzLDM5Ni43MDIyLDIwMC41Mzc1LDM5NS4yNzg4LDE5MC4wMTg4LDM5NiwxNzkuNSIgc3R5bGU9InN0cm9rZTogIzQ2ODg0Nzsgc3Ryb2tlLXdpZHRoOiAxLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nQW5kR2x5cGhzIiB0ZXh0TGVuZ3RoPSIzNyIgeD0iNDE2LjUiIHk9IjIwMi40OTUxIj5IVFRQPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iNTgiIHg9IjQwNiIgeT0iMjE4Ljc5MiI+RW5jb2RlcjwvdGV4dD48IS0tTUQ1PVtmM2JmMjMyZDkwY2FiYWU2NmYwNjA5YmE1MGViNGQxNl0KZW50aXR5IGFnZ3JlZ2F0b3ItLT48cG9seWdvbiBmaWxsPSIjREZGMEQ4IiBwb2ludHM9IjY0Miw4Mi41LDY0Miw4Mi43MTAyLDY1MS44LDgyLjA4NTcsNjYxLjYsODIuNjkzMyw2NzEuNCw4Mi44OTk3LDY4MS4yLDgxLjc4NjYsNjkxLDgyLjQyMjMsNzAwLjgsODIuMDczNSw3MTAuNiw4Mi4xMTY1LDcyMC40LDgyLjQzMTgsNzMwLjIsODEuODA4Niw3NDAsODIuNSw3NDAuNTUzNiw4Mi41LDczOS4zNjk3LDkzLjAxODgsNzM5LjgwMjIsMTAzLjUzNzUsNzQwLjQzMTksMTE0LjA1NjMsNzM5LjkxNDIsMTI0LjU3NSw3NDAsMTM1LjA5MzgsNzQwLDEzNS4xNjIsNzMwLjIsMTM1LjA2MTgsNzIwLjQsMTM1LjI3MjMsNzEwLjYsMTM1LjMzMjksNzAwLjgsMTM1LjY3OTQsNjkxLDEzNS43NjQ4LDY4MS4yLDEzNS43NzMsNjcxLjQsMTM1LjM0ODQsNjYxLjYsMTM1LjU1NzMsNjUxLjgsMTM1Ljc5Niw2NDIsMTM1LjA5MzgsNjQxLjI3ODgsMTM1LjA5MzgsNjQyLjY3ODUsMTI0LjU3NSw2NDEuNzAzNSwxMTQuMDU2Myw2NDIuNTMzOCwxMDMuNTM3NSw2NDEuNTA1LDkzLjAxODgsNjQyLDgyLjUiIHN0eWxlPSJzdHJva2U6ICM0Njg4NDc7IHN0cm9rZS13aWR0aDogMS41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iNzgiIHg9IjY1MiIgeT0iMTA1LjQ5NTEiPkh0dHAgT2JqZWN0PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iNzciIHg9IjY1Mi41IiB5PSIxMjEuNzkyIj5BZ2dyZWdhdG9yPC90ZXh0PjwhLS1NRDU9WzFjNGI4YmQ5ZmY0ZWYxMDY2NTU1OWUzNWE5ZTEyYTgzXQplbnRpdHkgaGFuZGxlci0tPjxwb2x5Z29uIGZpbGw9IiNERkYwRDgiIHBvaW50cz0iOTE5LDkzLDkxOSw5My4yMTAyLDkyOS41LDkyLjU4NTcsOTQwLDkzLjE5MzMsOTUwLjUsOTMuMzk5Nyw5NjEsOTIuMjg2Niw5NzEuNSw5Mi45MjIzLDk4Miw5Mi41NzM1LDk5Mi41LDkyLjYxNjUsMTAwMyw5MywxMDAyLjkzMTgsOTMsMTAwMi4zMDg2LDEwMi44MTUxLDEwMDMuNTUzNiwxMTIuNjMwMiwxMDAyLjM2OTcsMTIyLjQ0NTMsMTAwMi44MDIyLDEzMi4yNjA0LDEwMDMuNDMxOSwxNDIuMDc1NSwxMDAyLjkxNDIsMTUxLjg5MDYsMTAwMy4wNjgyLDE2MS43MDU3LDEwMDIuOTY4MSwxNzEuNTIwOCwxMDAzLjE3ODUsMTgxLjMzNTksMTAwMy4yMzkxLDE5MS4xNTEsMTAwMy41ODU3LDIwMC45NjYxLDEwMDMsMjEwLjc4MTMsMTAwMywyMTEuNDUyMyw5OTIuNSwyMTEuNDYwNSw5ODIsMjExLjAzNTksOTcxLjUsMjExLjI0NDgsOTYxLDIxMS40ODM1LDk1MC41LDIxMC4wNjAxLDk0MCwyMTEuNDU5OCw5MjkuNSwyMTAuNDg0Nyw5MTksMjEwLjc4MTMsOTE5LjUzMzgsMjEwLjc4MTMsOTE4LjUwNSwyMDAuOTY2MSw5MTguOTMxNSwxOTEuMTUxLDkxOS43NDE2LDE4MS4zMzU5LDkxOC45NTEzLDE3MS41MjA4LDkxOS4xMDUzLDE2MS43MDU3LDkxOS4zMzg2LDE1MS44OTA2LDkxOS40MTYyLDE0Mi4wNzU1LDkxOC45OTYxLDEzMi4yNjA0LDkxOS4yODcyLDEyMi40NDUzLDkxOC40Mjc2LDExMi42MzAyLDkxOS4yODQ0LDEwMi44MTUxLDkxOSw5MyIgc3R5bGU9InN0cm9rZTogIzQ2ODg0Nzsgc3Ryb2tlLXdpZHRoOiAxLjU7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nQW5kR2x5cGhzIiB0ZXh0TGVuZ3RoPSIwIiB4PSI5NjMiIHk9IjExNS45OTUxIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nQW5kR2x5cGhzIiB0ZXh0TGVuZ3RoPSIwIiB4PSI5NjMiIHk9IjEzMi4yOTIiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmdBbmRHbHlwaHMiIHRleHRMZW5ndGg9IjY0IiB4PSI5MjkiIHk9IjE0OC41ODg5Ij5CdXNpbmVzczwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmdBbmRHbHlwaHMiIHRleHRMZW5ndGg9IjUzIiB4PSI5MzQuNSIgeT0iMTY0Ljg4NTciPkhhbmRsZXI8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nQW5kR2x5cGhzIiB0ZXh0TGVuZ3RoPSIwIiB4PSI5NjMiIHk9IjE4MS4xODI2Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nQW5kR2x5cGhzIiB0ZXh0TGVuZ3RoPSIwIiB4PSI5NjMiIHk9IjE5Ny40Nzk1Ii8+PCEtLU1ENT1bNGE2NWU4NDA1OTAwNWQxMjY5M2EwODMzNzBhMDY3MTddCmVudGl0eSBjbGllbnQtLT48cG9seWdvbiBmaWxsPSIjREZGMEQ4IiBwb2ludHM9IjYsMTMxLjUsNiwxMzEuNzEwMiwxNS44MzMzLDEzMS4wODU3LDI1LjY2NjcsMTMxLjY5MzMsMzUuNSwxMzEuODk5Nyw0NS4zMzMzLDEzMC43ODY2LDU1LjE2NjcsMTMxLjQyMjMsNjUsMTMxLjUsNjQuNTczNSwxMzEuNSw2NC42MTY1LDE0MS4zNDE1LDY0LjkzMTgsMTUxLjE4Myw2NC4zMDg2LDE2MS4wMjQ2LDY1LjU1MzYsMTcwLjg2NjEsNjQuMzY5NywxODAuNzA3Niw2NC44MDIyLDE5MC41NDkxLDY1LDIwMC4zOTA2LDY1LDIwMC44MjI2LDU1LjE2NjcsMjAwLjMwNDgsNDUuMzMzMywyMDAuNDU4OSwzNS41LDIwMC4zNTg3LDI1LjY2NjcsMjAwLjU2OTIsMTUuODMzMywyMDAuNjI5OCw2LDIwMC4zOTA2LDYuNTg1NywyMDAuMzkwNiw2LjY3MTEsMTkwLjU0OTEsNi42NzkzLDE4MC43MDc2LDYuMjU0NiwxNzAuODY2MSw2LjQ2MzYsMTYxLjAyNDYsNi43MDIyLDE1MS4xODMsNS4yNzg4LDE0MS4zNDE1LDYsMTMxLjUiIHN0eWxlPSJzdHJva2U6ICM0Njg4NDc7IHN0cm9rZS13aWR0aDogMS41OyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iMCIgeD0iMzcuNSIgeT0iMTU0LjQ5NTEiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmdBbmRHbHlwaHMiIHRleHRMZW5ndGg9IjM5IiB4PSIxNiIgeT0iMTcwLjc5MiI+Q2xpZW50PC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iMCIgeD0iMzcuNSIgeT0iMTg3LjA4ODkiLz48IS0tTUQ1PVtjMzY1YmQ2YzY5NmIxZGM2YTI0ZTZkMzAyZDdkOTBmNF0KbGluayBjbGllbnQgdG8gc3NsLS0+PHBhdGggZD0iTTY1LjQyMTUsMTY2IEw2NS40MjE1LDE2Ni4yODAyIEw3NS4yODQ1LDE2NS40NDc2IEw4NS4xNDc0LDE2Ni4yNTc3IEw5NS4wMTA0LDE2Ni41MzI5IEwxMDQuODczNCwxNjUuMDQ4OCBMMTE0LjczNjMsMTY1Ljg5NjQgTDEyNC41OTkzLDE2NS40MzEzIEwxMzQuNDYyMiwxNjUuNDg4NyBMMTQ0LjMyNTIsMTY1LjkwOTEgTDE1NC4xODgyLDE2NS4wNzgyIEwxNjQuMDUxMSwxNjYuNzM4MiBMMTczLjkxNDEsMTY1LjE1OTYgTDE4My43NzcxLDE2NS43MzYzIEwxOTMuNjQsMTY2LjU3NTkgTDIwMy41MDMsMTY2ICIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTogIzQ2NzQ5Rjsgc3Ryb2tlLXdpZHRoOiAxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzQ2NzQ5RiIgcG9pbnRzPSIyMDguODYyLDE2NiwyMDguODkwNSwxNjYuMDY0LDIwNy4wMDU5LDE2NS4wNzM4LDIwNS4yODgyLDE2NC40NTg5LDIwMy41MTYxLDE2My43MjE3LDIwMS41NjU0LDE2Mi41ODI3LDE5OS44NjIsMTYyLDE5OS44NDM3LDE2MS45ODE3LDIwMC41NjE1LDE2Mi42OTk1LDIwMS4zNzE2LDE2My41MDk2LDIwMi4yNDU5LDE2NC4zODM5LDIwMi44OTksMTY1LjAzNywyMDMuODYyLDE2NiwyMDMuOTkyNSwxNjYuMTMwNSwyMDIuOTEzNCwxNjYuNjUxNCwyMDIuMjE1NCwxNjcuNTUzNCwyMDEuNTYzOCwxNjguNTAxOCwyMDAuNjQxOCwxNjkuMTc5OCwxOTkuODYyLDE3MCwxOTkuODcxMiwxNzAuMDIwOCwyMDEuNjU3NywxNjkuMTkwMywyMDMuNDg2MiwxNjguNDU0NCwyMDUuMjk0NCwxNjcuNjcyOCwyMDcuMTQxMywxNjYuOTc4NCwyMDguODYyLDE2NiIgc3R5bGU9InN0cm9rZTogIzQ2NzQ5Rjsgc3Ryb2tlLXdpZHRoOiAxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nQW5kR2x5cGhzIiB0ZXh0TGVuZ3RoPSI4MCIgeD0iOTYiIHk9IjE2Mi4wNjY5Ij4wLiBlbmNyeXB0ZWQ8L3RleHQ+PCEtLU1ENT1bNWVmNzA1OWNmNzJjMWRkNmJhZjM0NWFkNGYzYTRiYzNdCnJldmVyc2UgbGluayBjbGllbnQgdG8gc3NsLS0+PHBhdGggZD0iTTcwLjA4MTMsMTgzLjA3MTYgTDcwLjExMzcsMTgzLjE1OTIgTDcyLjQ4MjIsMTgzLjgwOTggTDc1LjA0MDUsMTg0Ljk3NCBMNzcuNTM3LDE4NS45NzA5IEw3OS44MzAzLDE4Ni40MTc4IEw4Mi40MDQ5LDE4Ny42MjYxIEw4Mi4zOTYsMTg3LjU5MjggTDg0Ljg3NDksMTg4LjExNzggTDg3LjM5ODgsMTg4LjgxMSBMODkuOTU0MSwxODkuNjIxMiBMOTIuNDAxNSwxOTAuMDI4NCBMOTUsMTkxIEw5NS4wNDY0LDE5MS4yNDE2IEw5Ny40MDc4LDE5MS4xOTc0IEw5OS45MDQ2LDE5MS44NTg2IEwxMDIuNDE4LDE5Mi42MDU5IEwxMDQuODM1MiwxOTIuODUyNCBMMTA3LjMwMywxOTMuMzYyMyBMMTA3LjMwNzcsMTkzLjM5MjMgTDEwOS40MDY0LDE5My42NzM0IEwxMTEuNTI2MSwxOTQuMDkwOSBMMTEzLjYzNTcsMTk0LjQ0MjYgTDExNS43NjQ3LDE5NC45MTk5IEwxMTcuODMwNSwxOTQuOTg3OCBMMTE3Ljg0OTYsMTk1LjI4NTQgTDEyMS40NzExLDE5NS41MjE5IEwxMjUuMDgwMiwxOTUuNTY2NSBMMTI4LjcwNzQsMTk1Ljg5MiBMMTMyLjMzNTQsMTk2LjIzMDcgTDEzNS45MzY2LDE5Ni4xNTIxIEwxMzUuOTExOCwxOTUuODMyNiBMMTM5LjU4NzYsMTk2LjE3MDQgTDE0My4xODE1LDE5NS40NTYxIEwxNDYuODM3NywxOTUuNTQxNiBMMTUwLjQyOTgsMTk0LjgwMzQgTDE1NC4wNzQ1LDE5NC43NDA0IEwxNTQuMDY5OSwxOTQuNzEwMyBMMTU2LjIzNywxOTQuNzQ3NCBMMTU4LjI5OCwxOTQuMDgxMiBMMTYwLjQyMTcsMTkzLjgyOTkgTDE2Mi41NTA2LDE5My42MTM2IEwxNjQuNjQxNSwxOTMuMTQ1OCBMMTY0LjY3MzIsMTkzLjMyODEgTDE2Ny4xMTI5LDE5Mi43MTQ5IEwxNjkuNjA2NywxOTIuNDEzMyBMMTcyLjAxMzEsMTkxLjYwNzcgTDE3NC41NDk5LDE5MS41NTM3IEwxNzcsMTkxIEwxNzcuMDU2OCwxOTEuMjM2OSBMMTgwLjI1NzcsMTkwLjQyMjUgTDE4My40ODY5LDE4OS43MjU4IEwxODYuNTg1MSwxODguNDgyNCBMMTg5Ljc3OTMsMTg3LjYzOTcgTDE5My4wNTg1LDE4Ny4xNTIgTDE5Mi45NzExLDE4Ni44OSBMMTk2LjE4NDUsMTg2LjA4MTQgTDE5OS4yOTk1LDE4NC45Nzc2IEwyMDIuNTU3MywxODQuMzAyIEwyMDUuNTcxMSwxODIuODk1MyBMMjA4LjczLDE4MS45MjMyICIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTogI0ZGMDAwMDsgc3Ryb2tlLXdpZHRoOiAxLjA7Ii8+PHBvbHlnb24gZmlsbD0iI0ZGMDAwMCIgcG9pbnRzPSI2NS4yMDkyLDE4MC45OTM2LDY1LjI2MDUsMTgxLjA0MTMsNjYuNDQ5OSwxODIuMzQxNiw2Ny45NDAxLDE4My45MjE2LDY5LjMzMjMsMTg1LjQxMDUsNzAuNDAyNSwxODYuNTk5Nyw3MS45MTg0LDE4OC4yMDM4LDcxLjg5NDQsMTg4LjE5NDEsNzEuMzY0NSwxODcuMTAxLDcwLjk1NTgsMTg2LjA1NjYsNzAuNjMxMywxODUuMDQ2MSw3MC4wMTY1LDE4My45MTg5LDY5LjgwODQsMTgyLjk1NTIsNjkuODc3MiwxODMuMTI2NCw3MC43Nzk3LDE4Mi4zMzgyLDcxLjg4MzIsMTgyLjA1LDczLjAxMTIsMTgxLjgyMjcsNzMuOTk2NiwxODEuMjQwNiw3NS4wNTY5LDE4MC44NDUxLDc1LjA1NzMsMTgwLjg2NzksNzMuMDg3MiwxODAuODY0Miw3MS4xMTg3LDE4MC45NjQsNjkuMTQ5NSwxODEuMDEzOSw2Ny4xODE3LDE4MS4xNTkxLDY1LjIwOTIsMTgwLjk5MzYiIHN0eWxlPSJzdHJva2U6ICNGRjAwMDA7IHN0cm9rZS13aWR0aDogMS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iODAiIHg9Ijk2IiB5PSIxODcuMDY2OSI+Ni4gZW5jcnlwdGVkPC90ZXh0PjwhLS1NRDU9WzE5ZGY0MTQwNzQ1MDg1NDMwM2ZiZTRmMzk3OTY1ZDA0XQpsaW5rIHNzbCB0byBkZWNvZGVyLS0+PHBhdGggZD0iTTI4Mi4yMDksMTUwLjc2NCBMMjgyLjMxOSwxNTEuMDIxOCBMMjkwLjk4MzUsMTQ2LjQxOTYgTDMwMC4yOTI2LDE0My4zMjg1IEwzMDkuMzkxOSwxMzkuNzQ1NCBMMzE3LjgwMDcsMTM0LjU0NDEgTDMyNy4xMjQ2LDEzMS40ODc0IEwzMzUuOTMzMywxMjcuMjIzNSBMMzQ0Ljk0NzEsMTIzLjQzOTkgTDM1NC4xMDMzLDExOS45OTA0IEwzNjIuNzY4NSwxMTUuMzg5OSBMMzcyLjQxMTIsMTEzLjA4MDUgTDM4MC43ODMsMTA3Ljc5MjMgTDM5MC4xMDQsMTA0LjcyOSAiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6ICM0Njc0OUY7IHN0cm9rZS13aWR0aDogMS4wOyIvPjxwb2x5Z29uIGZpbGw9IiM0Njc0OUYiIHBvaW50cz0iMzk0Ljg2NCwxMDIuNjk4LDM5NC44NjUsMTAyLjc2ODEsMzkyLjg5MjQsMTAyLjUzMDgsMzkwLjkyNTgsMTAyLjcwNDEsMzg4Ljk1NzMsMTAyLjc0MzgsMzg2Ljk4MjMsMTAyLjM0MzcsMzg1LjAxNjIsMTAyLjU1MjMsMzg1LjAwNjYsMTAyLjUyODIsMzg2LjAxMzEsMTAyLjg0MjEsMzg3LjA2ODIsMTAzLjI3NzEsMzg4LjE1NzMsMTAzLjc5NjQsMzg5LjEyOTcsMTA0LjAyNTMsMzkwLjI2NTQsMTA0LjY2MDksMzkwLjQzNjYsMTA0LjcyOTcsMzg5LjY0ODcsMTA1LjYzMjQsMzg5LjM2MDgsMTA2LjczNiwzODkuMTMzOSwxMDcuODY0LDM4OC41NTIsMTA4Ljg0OTYsMzg4LjE1NjgsMTA5LjkxLDM4OC4xNzM1LDEwOS45MjU1LDM4OS40OTA1LDEwOC40NjA0LDM5MC44ODMzLDEwNy4wNjU4LDM5Mi4yMzk1LDEwNS42MzcxLDM5My42NjU1LDEwNC4yNzM0LDM5NC44NjQsMTAyLjY5OCIgc3R5bGU9InN0cm9rZTogIzQ2NzQ5Rjsgc3Ryb2tlLXdpZHRoOiAxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nQW5kR2x5cGhzIiB0ZXh0TGVuZ3RoPSI1MSIgeD0iMzEzIiB5PSIxMTMuMDY2OSI+MS4gYnl0ZXM8L3RleHQ+PCEtLU1ENT1bMmZiMGRmM2RjZDRlN2RjYzAyM2RhODg0ZGZiNDA1OTVdCmxpbmsgZGVjb2RlciB0byBhZ2dyZWdhdG9yLS0+PHBhdGggZD0iTTQ3NS4xMzEsODkuNTQzIEw0NzUuMTU2Myw4OS44MjIxIEw0ODUuMTY3Nyw4OS45MDYyIEw0OTUuMzI3NCw5MS42MjY0IEw1MDUuNDM4Nyw5Mi44MTM5IEw1MTUuMzkxNSw5Mi4yNDkyIEw1MjUuNTU0NSw5NC4wMDY3IEw1MzUuNTk5MSw5NC40NTY5IEw1NDUuNjkwOCw5NS40Mjc0IEw1NTUuODE1Myw5Ni43NTk1IEw1NjUuODI2OSw5Ni44NDUzIEw1NzYuMDYzMiw5OS40MTE5IEw1ODYuMDA3NCw5OC43NTMyIEw1OTYuMTQ2LDEwMC4yNDA5IEw2MDYuMzA4MywxMDEuOTkwNSBMNjE2LjMzMjYsMTAyLjIxNjMgTDYyNi40Mzc2LDEwMy4zMzQyIEw2MzYuNTE2LDEwNC4xNTcgIiBmaWxsPSJub25lIiBzdHlsZT0ic3Ryb2tlOiAjNDY3NDlGOyBzdHJva2Utd2lkdGg6IDEuMDsiLz48cG9seWdvbiBmaWxsPSIjNDY3NDlGIiBwb2ludHM9IjY0MS43MDQsMTA0LjYyNyw2NDEuNzM4MSwxMDQuNjg4Miw2MzkuOTE2MywxMDMuNTQ3MSw2MzguMjk0NSwxMDIuNzY0OCw2MzYuNjA3NiwxMDEuODY1Nyw2MzQuNzA2NSwxMDAuNTgyNCw2MzMuMTAxOSw5OS44MzA4LDYzMy4wODIsOTkuODE0Miw2MzMuNzE3MiwxMDAuNjA4Nyw2MzQuNDUyNywxMDEuNDg2OSw2MzUuMjU3OSwxMDIuNDIzMSw2MzUuODIyOSwxMDMuMTU5MSw2MzYuNzI0NCwxMDQuMTc1Niw2MzYuODQyNiwxMDQuMzE3NCw2MzUuNzIwOSwxMDQuNzM4OCw2MzQuOTQ0MywxMDUuNTc0LDYzNC4yMDk4LDEwNi40NTk3LDYzMy4yMzAzLDEwNy4wNTE3LDYzMi4zNzk2LDEwNy43OTgyLDYzMi4zODcsMTA3LjgxOTcsNjM0LjI0MTEsMTA3LjE1MzgsNjM2LjEyODUsMTA2LjU4Niw2MzcuOTk5OSwxMDUuOTcwOSw2MzkuOTAyLDEwNS40NDYxLDY0MS43MDQsMTA0LjYyNyIgc3R5bGU9InN0cm9rZTogIzQ2NzQ5Rjsgc3Ryb2tlLXdpZHRoOiAxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nQW5kR2x5cGhzIiB0ZXh0TGVuZ3RoPSIxMDUiIHg9IjUwNiIgeT0iNzQuMDY2OSI+Mi4gaHR0cCBtYXNzYWdlPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iNDUiIHg9IjUzNiIgeT0iODkuMTk5NyI+Y2h1bmtzPC90ZXh0PjwhLS1NRDU9WzhiODg3OTNlM2U5NjFiMzQ0OGVlOTllY2Q5ZGQ1MmI2XQpsaW5rIGFnZ3JlZ2F0b3IgdG8gaGFuZGxlci0tPjxwYXRoIGQ9Ik03NDAuMjIzLDExNi43MzcgTDc0MC4yNjc0LDExNy4wMTM3IEw3NDkuNzY1NSwxMTcuNzM2NyBMNzU5LjUyMzgsMTIwLjA4MTcgTDc2OS4xOTc0LDEyMS44OTg1IEw3NzguNTkyMywxMjEuOTc4MyBMNzg4LjM1NjYsMTI0LjM2MDIgTDc5Ny45MTI5LDEyNS40NDYyIEw4MDcuNTUyLDEyNy4wNDc5IEw4MTcuMjQ4NiwxMjkuMDA4MiBMODI2Ljc0NywxMjkuNzMyOCBMODM2LjYzOTksMTMyLjkxNyBMODQ2LjAxOTksMTMyLjkwMzUgTDg1NS43NDEyLDEzNS4wMTggTDg2NS41MDQyLDEzNy4zOTIxIEw4NzUuMDI0OSwxMzguMjU1NiBMODg0LjY4NzQsMTQwLjAwMzUgTDg5NC4yOTYzLDE0MS40MTY3IEw5MDMuOTcwNywxNDMuMjM4OSBMOTEzLjU2MywxNDQuNTQ5ICIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTogIzQ2NzQ5Rjsgc3Ryb2tlLXdpZHRoOiAxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzQ2NzQ5RiIgcG9pbnRzPSI5MTguNzUyLDE0NS4zODIsOTE4Ljc5MDIsMTQ1LjQ0MDcsOTE3LjAyNjIsMTQ0LjE5MSw5MTUuNDg2NCwxNDMuMjg1NCw5MTMuODczNiwxNDIuMjY3OCw5MTIuMDIwNywxNDAuODgxNiw5MTAuNTAwMSwxNDAuMDA1Niw5MTAuNDc5MSwxMzkuOTkwNCw5MTEuMDQ3OSwxNDAuODM5LDkxMS43MjI2LDE0MS43NjQxLDkxMi40NzA4LDE0Mi43NDI0LDkxMi45NjU1LDE0My41Mzc0LDkxMy44MTUzLDE0NC41ODkyLDkxMy45MjM0LDE0NC43Mzg3LDkxMi43NzU0LDE0NS4wODIsOTExLjk0MzIsMTQ1Ljg2MTksOTExLjE0OTUsMTQ2LjY5NSw5MTAuMTMxNiwxNDcuMjE4Miw5MDkuMjMxNiwxNDcuOTA0NCw5MDkuMjM3NCwxNDcuOTI2NCw5MTEuMTMzLDE0Ny4zODk2LDkxMy4wNTUsMTQ2Ljk1MjksOTE0Ljk2NDMsMTQ2LjQ2OCw5MTYuODk3OSwxNDYuMDc1Miw5MTguNzUyLDE0NS4zODIiIHN0eWxlPSJzdHJva2U6ICM0Njc0OUY7IHN0cm9rZS13aWR0aDogMS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iMTE3IiB4PSI3NzEiIHk9IjExOC4wNjY5Ij4zLiBmdWxsIGh0dHAgcmVxdWVzdDwvdGV4dD48IS0tTUQ1PVs1ZDVmMjEwYzgxYjdmNTMwNTI0MTQ5OTk0OGM0MTkzZV0KcmV2ZXJzZSBsaW5rIGVuY29kZXIgdG8gaGFuZGxlci0tPjxwYXRoIGQ9Ik00NzkuMjk3LDIwMS41MzgxIEw0NzkuMzI1NywyMDEuODE2OSBMNDg5LjIyOTIsMTk5Ljk1OTIgTDQ5OS4zMDExLDE5OS43MzU3IEw1MDkuMzE4MSwxOTguOTggTDUxOS4xNTQ4LDE5Ni40NzQ0IEw1MjkuMjMwNSwxOTYuMjg4MSBMNTM5LjE3MTYsMTk0Ljc5NjEgTDU0OS4xNjYzLDE5My44MjM3IEw1NTkuMTk4MiwxOTMuMjEyNiBMNTY5LjEwMTksMTkxLjM1NjYgTDU3OS4yNjA5LDE5MS45Nzg1IEw1ODkuMDg3OSwxODkuMzc4OSBMNTk5LjEzNTgsMTg4LjkyMzEgTDYwOS4yMTA3LDE4OC43Mjg5IEw2MTkuMTI4NywxODcuMDEyOSBMNjI5LjEzODYsMTg2LjE4NzggTDYzOS4xMTM3LDE4NS4wMjU1IEw2NDkuMTMxMywxODQuMjc1MyBMNjU5LjEyODQsMTgzLjMyNjMgTDY2OS4xNjQ2LDE4Mi43NTY1IEw2NzkuMTY1MSwxODEuODQwNCBMNjg5LjE1NSwxODAuODIxOCBMNjk5LjA4NTgsMTc5LjIyOTMgTDcwOS4xMDMyLDE3OC40NzcgTDcxOS4xMjQ2LDE3Ny43NjQxIEw3MjguOTE4OSwxNzQuODQ2OSBMNzM5LjA5OSwxNzUuNjczOSBMNzQ4Ljk1NDYsMTczLjM1MTQgTDc1OS4wNTY5LDE3My40MjMyIEw3NjguOTA1MSwxNzEuMDI5MyBMNzc4Ljk1MjIsMTcwLjU2NTYgTDc4OS4wNTE3LDE3MC42MTA3IEw3OTguOTMyNSwxNjguNTMzIEw4MDguOTQyNCwxNjcuNzA3OSBMODE4Ljk2MzEsMTY2Ljk4OCBMODI4Ljk2MjUsMTY2LjA2MTUgTDgzOC44OTM5LDE2NC40NzQ5IEw4NDguOTIyNSwxNjMuODMxNyBMODU4Ljc5MzksMTYxLjY2MjEgTDg2OC44OTk4LDE2MS43NjkxIEw4NzguOTI0NywxNjEuMDg5NiBMODg4Ljg5OTMsMTU5LjkyMjggTDg5OC45MTEyLDE1OS4xMTY4IEw5MDguNzUwMiwxNTYuNjMzNyBMOTE4LjgwNSwxNTYuMjQ1ICIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTogI0ZGMDAwMDsgc3Ryb2tlLXdpZHRoOiAxLjA7Ii8+PHBvbHlnb24gZmlsbD0iI0ZGMDAwMCIgcG9pbnRzPSI0NzQuMTA3LDIwMi4wNzMsNDc0LjEyODcsMjAyLjEzOTYsNDc1LjkzNjcsMjAyLjU1MjksNDc3Ljg3MjEsMjAzLjM1NjYsNDc5Ljc2NiwyMDQuMDMzMSw0ODEuNTIzNSwyMDQuMjkxNiw0ODMuNDY5OCwyMDUuMTI4OCw0ODMuNDUzNSwyMDUuMTA4Nyw0ODIuNTAyMywyMDQuMzA0Nyw0ODEuNjMzNSwyMDMuNjAyMSw0ODAuODIyLDIwMi45Nyw0NzkuODEzMSwyMDIuMDk1MSw0NzkuMDgwNiwyMDEuNTYwMiw0NzkuMjIzOCwyMDEuNjc2Niw0NzkuNjMxMywyMDAuNTQ5OCw0ODAuNDU2OSwxOTkuNzYyOSw0ODEuMzMzNSwxOTkuMDE3NSw0ODEuOTEzMywxOTguMDMwOCw0ODIuNjQ5MywxOTcuMTcxLDQ4Mi42NjA2LDE5Ny4xOTA3LDQ4MC45MzU1LDE5OC4xNDIxLDQ3OS4yNjIsMTk5LjE4MzQsNDc3LjU2MzYsMjAwLjE4MTMsNDc1LjkxMjYsMjAxLjI2MTksNDc0LjEwNywyMDIuMDczIiBzdHlsZT0ic3Ryb2tlOiAjRkYwMDAwOyBzdHJva2Utd2lkdGg6IDEuMDsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmdBbmRHbHlwaHMiIHRleHRMZW5ndGg9Ijg1IiB4PSI2NDguNSIgeT0iMTcxLjA2NjkiPjQuIGh0dHAgb2JqZWN0PC90ZXh0PjwhLS1NRDU9W2FkODM5MzYwYWE0NmNlZTliOTAzNzEwZDE0N2JkZTIxXQpyZXZlcnNlIGxpbmsgc3NsIHRvIGVuY29kZXItLT48cGF0aCBkPSJNMjg3LjI3NywxNzQuNjk5IEwyODcuMzM1NSwxNzQuOTczMSBMMjk3LjAzMTcsMTc2LjI2NDMgTDMwNy4wNzA2LDE3OS4xNjIyIEwzMTYuOTk3OSwxODEuNTM3IEwzMjYuNTU4MiwxODIuMTkxMSBMMzM2LjYwNDksMTg1LjEyNTcgTDM0Ni4zNzc4LDE4Ni43NzY1IEwzNTYuMjU5NywxODguOTM4MSBMMzY2LjIxNzMsMTkxLjQ1NDkgTDM3NS45MTM5LDE5Mi43NDc5IEwzODYuMTMwMSwxOTYuNDc2OSBMMzk1Ljg0NiwxOTcuODYwNiAiIGZpbGw9Im5vbmUiIHN0eWxlPSJzdHJva2U6ICNGRjAwMDA7IHN0cm9rZS13aWR0aDogMS4wOyIvPjxwb2x5Z29uIGZpbGw9IiNGRjAwMDAiIHBvaW50cz0iMjgyLjIwOSwxNzMuNjE3OCwyODIuMjUwMiwxNzMuNjc0NSwyODMuNzIxLDE3NC42NjQ0LDI4NS40MzMzLDE3NS45ODY1LDI4Ny4wNjcsMTc3LjIwMDQsMjg4LjQ0MjEsMTc4LjA1ODYsMjkwLjE3NTIsMTc5LjQwOTIsMjkwLjE1MzQsMTc5LjM5NTEsMjg5LjQ0MDYsMTc4LjM4MjUsMjg4LjgzNzMsMTc3LjQ0MDgsMjg4LjMxMDIsMTc2LjU0ODUsMjg3LjUyMDYsMTc1LjQ4NjEsMjg3LjA5ODcsMTc0LjY2MiwyODcuMTk5MSwxNzQuODE2OSwyODcuOTMzOSwxNzMuODcwNCwyODguOTYxOCwxNzMuMzc2MSwyOTAuMDI1NCwxNzIuOTM3LDI5MC44ODA5LDE3Mi4xNzY5LDI5MS44NDU5LDE3MS41ODU2LDI5MS44NTA2LDE3MS42MDc5LDI4OS45MTYzLDE3MS45ODE2LDI4OC4wMDM0LDE3Mi40NTY3LDI4Ni4wODAyLDE3Mi44ODI5LDI4NC4xNzY3LDE3My40MDI0LDI4Mi4yMDksMTczLjYxNzgiIHN0eWxlPSJzdHJva2U6ICNGRjAwMDA7IHN0cm9rZS13aWR0aDogMS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iNTEiIHg9IjMxMyIgeT0iMTc2LjA2NjkiPjUuIGJ5dGVzPC90ZXh0PjwhLS1NRDU9W2IwOThjM2Q1ZjA0M2NjY2E2ZDJiZGM1N2RiOTBiM2I4XQpyZXZlcnNlIGxpbmsgZW5jb2RlciB0byBkZWNvZGVyLS0+PHBhdGggZD0iTTQzNSwxNzQuMDkxNSBMNDM1LjI4MDIsMTc0LjA5MTUgTDQzNC40NDc2LDE2My44MzU4IEw0MzUuMjU3NywxNTMuNTggTDQzNS41MzI5LDE0My4zMjQzIEw0MzQuMDQ4OCwxMzMuMDY4NSBMNDM0Ljg5NjQsMTIyLjgxMjggTDQzNSwxMTIuNTU3ICIgZmlsbD0ibm9uZSIgc3R5bGU9InN0cm9rZTogI0ZGMDAwMDsgc3Ryb2tlLXdpZHRoOiAxLjA7IHN0cm9rZS1kYXNoYXJyYXk6IDcuMCw3LjA7Ii8+PHBvbHlnb24gZmlsbD0iI0ZGMDAwMCIgcG9pbnRzPSI0MzUsMTc5LjM2ODEsNDM1LjA2NCwxNzkuMzk2Niw0MzUuNjczOCwxNzcuNTEyLDQzNi42NTg5LDE3NS43OTQzLDQzNy41MjE3LDE3NC4wMjIyLDQzNy45ODI3LDE3Mi4wNzE1LDQzOSwxNzAuMzY4MSw0MzguOTgxNywxNzAuMzQ5OCw0MzguMDk5NSwxNzEuMDY3Niw0MzcuMzA5NiwxNzEuODc3Nyw0MzYuNTgzOSwxNzIuNzUyLDQzNS42MzcsMTczLjQwNTEsNDM1LDE3NC4zNjgxLDQzNS4xMzA1LDE3NC40OTg2LDQzNC4wNTE0LDE3My40MTk1LDQzMy4zNTM0LDE3Mi43MjE1LDQzMi43MDE4LDE3Mi4wNjk5LDQzMS43Nzk4LDE3MS4xNDc5LDQzMSwxNzAuMzY4MSw0MzEuMDIwOCwxNzAuMzc3Myw0MzEuNzkwMywxNzIuMTYzOCw0MzIuNjU0NCwxNzMuOTkyMyw0MzMuNDcyOCwxNzUuODAwNSw0MzQuMzc4NCwxNzcuNjQ3NCw0MzUsMTc5LjM2ODEiIHN0eWxlPSJzdHJva2U6ICNGRjAwMDA7IHN0cm9rZS13aWR0aDogMS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iMTMwIiB4PSIzNjciIHk9IjE0My4wNjY5Ij53cml0ZSByZXNwb25zZSB3aGVuPC90ZXh0Pjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZ0FuZEdseXBocyIgdGV4dExlbmd0aD0iODciIHg9IjM3Mi41IiB5PSIxNTguMTk5NyI+ZGVjb2RpbmcgZmFpbHM8L3RleHQ+PC9nPjwvc3ZnPg==" alt=""/>
</div>
<div class="title">Figure 1. Channel pipeline执行顺序</div>
</div>
<div class="paragraph">
<p>在对应pipeline中，handler可能是以如下顺序被依次注册，netty会按我们注册的顺序先依次调用所有的inbound handler，直到处理完所有读取事件后，在写事件中再调用outbound handler。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ChannelPipeline p = ...;
...
// addLast() 方法将 handler 加入链尾
p.addLast("encoder", new HttpResponseEncoder()); <b class="conum">(1)</b>
p.addLast("decoder", new HttpRequestDecoder());  <b class="conum">(2)</b>
p.addLast("aggregator", new HttpObjectAggregator(1048576));
...
p.addLast("handler", new BusinessHandler());</code></pre>
</div>
</div>
<div class="paragraph">
<p>需要注意的是，在handler中调用 <code>ctx.write()</code> 方法时，只会触发注册顺序在当前handler之前的handler。例如上例代码，如果encoder和decoder注册顺序反过来，那么在decoder中调用 <code>ctx.write()</code> 将不会触发 encoder。这时虽然可以通过 <code>channel.write()</code> 触发整个调用链，但相对低效，并不推荐。</p>
</div>
</div>
<div class="sect2">
<h3 id="_events_handlers">1.3. Events &amp; Handlers</h3>
<div class="paragraph">
<p>Netty使用事件驱动，利用事件在handler之间传递消息，例如上面的http message传递就是由前一个 handler 调用 <code>channelHandlerContext.fireChannelRead(msg)</code> 方法来通知下一个 handler 处理 ChannelRead 事件，并且这个事件中携带了 msg 这个对象。</p>
</div>
<div class="paragraph">
<p>事件和 inbound/outbound 数据流相关。Inbound事件有以下几种:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Channel激活和失活</p>
</li>
<li>
<p>读操作事件</p>
</li>
<li>
<p>异常事件</p>
</li>
<li>
<p>用户事件，例如心跳</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Outbound事件则比较简单，通常是打开/关闭连接或写入/刷新数据。</p>
</div>
<div class="paragraph">
<p>Netty 应用程序则由 inbound 和 outbound 两类事件及其处理程序组成。事件处理的基本接口是 ChannelOutboundHandler、ChannelInboundHandler。Netty本身提供了庞大的ChannelHandler实现层次结构。很多适配器虽然只是一些空的实现，例如 ChannelInboundHandlerAdapter 和 ChannelOutboundHandlerAdapter。但当只需要处理少数事件时，我们可以方便的继承这些适配器。此外，Netty 还有许多特定协议的实现，例如对HTTP协议提供了HttpRequestDecoder, HttpResponseEncoder, HttpObjectAggregator 等 handler。</p>
</div>
</div>
<div class="sect2">
<h3 id="_encoders_decoders">1.4. Encoders &amp; Decoders</h3>
<div class="paragraph">
<p>从网络层到应用层的数据转换通常涉及数据序列化和反序列化，因此Netty引入了 <code>Encoder</code> 和 <code>Decoder</code> 概念，但它们本身也都是 Handler。其中 Decoder 负责反序列化，通常可以基于 <code>ByteToMessageDecoder</code> 开发自己的解码器。对应的，Encoder 通常基于 <code>MessageToByteEncoder</code> 开发。Netty自己也带了大量编解码器，可以处理常见协议。</p>
</div>
</div>
<div class="sect2">
<h3 id="_future">1.5. Future</h3>
<div class="paragraph">
<p>Netty中所有的IO操作都是异步的。类似Java标准库中的异步操作，Netty也提供了 <code>Future</code> 接口，但不同的是Netty的Future对完成状态有更精细的定义，并可以添加 <code>FutureListener</code> 作为回调，以便操作完成后被调用。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>                                      +---------------------------+
                                      | Completed successfully    |
                                      +---------------------------+
                                 +----&gt;      isDone() = true      |
 +--------------------------+    |    |   isSuccess() = true      |
 |        Uncompleted       |    |    +===========================+
 +--------------------------+    |    | Completed with failure    |
 |      isDone() = false    |    |    +---------------------------+
 |   isSuccess() = false    |----+----&gt;      isDone() = true      |
 | isCancelled() = false    |    |    |       cause() = non-null  |
 |       cause() = null     |    |    +===========================+
 +--------------------------+    |    | Completed by cancellation |
                                 |    +---------------------------+
                                 +----&gt;      isDone() = true      |
                                      | isCancelled() = true      |
                                      +---------------------------+</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
注意千万不要在ChannelHandler中调用 <code>await()</code> 或 <code>sync()</code>，Handler 中的操作都应该是异步的。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_服务端应用">2. 服务端应用</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_server初始化">2.1. Server初始化</h3>
<div class="paragraph">
<p>服务端的启动主要就是通过 <code>ServerBootstrap</code> 对象来设置服务器的线程池、socket参数和Channel Pipeline，我们来看看一个完整的服务端例子。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Slf4j
public class RpcServer {
    EventLoopGroup bossGroup = new NioEventLoopGroup(); <b class="conum">(1)</b>
    EventLoopGroup workerGroup = new NioEventLoopGroup(new DefaultThreadFactory("server")); <b class="conum">(2)</b>

    private int port;
    public RpcServer(int port) throws Exception {
        this.port = port;
        this.run();
    }

    public void stop(){  <b class="conum">(3)</b>
        bossGroup.shutdownGracefully();
        workerGroup.shutdownGracefully();
    }

    private void run() throws Exception {
        ServerBootstrap b = new ServerBootstrap();
        b.group(bossGroup, workerGroup);
        b.channel(NioServerSocketChannel.class);
        b.childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {
            @Override
            public void initChannel(SocketChannel ch) throws Exception {
                ch.pipeline()
                        .addLast(new LoggingHandler(LogLevel.INFO))  <b class="conum">(4)</b>
                        .addLast(new ResponseEncoder(),     <b class="conum">(5)</b>
                                 new RequestDecoder(),      <b class="conum">(6)</b>
                                 new ProcessingHandler());  <b class="conum">(7)</b>
            }
        });
        b.option(ChannelOption.SO_BACKLOG, 128);   <b class="conum">(8)</b>
        b.childOption(ChannelOption.SO_KEEPALIVE, true);  <b class="conum">(9)</b>

        ChannelFuture f = b.bind(port).sync();
        f.channel().closeFuture().addListener((ChannelFutureListener) future -&gt; {
            log.info(future.channel().toString() + " 链路关闭");
            stop();
        });
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>用于acceptor的线程池。</p>
</li>
<li>
<p>用于worker的线程池，这个池理论上应该仅用于IO操作，如果你的Handler里面有阻塞操作，考虑将任务提交到单独的线程池，而不是扩展worker池大小。我们这里配置了线程组的名字，方便thread dump的时候做区分。</p>
</li>
<li>
<p>EventLoopGroup启动后不会主动退出，如果想关闭服务器，需要主动调用 shutdown 方法。</p>
</li>
<li>
<p>我们将 LoggingHandler 作为第一个 handler 加入channel pipeline，以便核对入站和出站的字节流。当然也可以将它放在 decoder 后面，用于记录解码后的对象。</p>
</li>
<li>
<p>Response对象的encoder，用于将对象序列化为字节流。</p>
</li>
<li>
<p>Request对象的decoder，用于从字节流提取并反序列化对象。注意我们将decoder放在encoder后面，这样如果decoder出现问题，可以直接回复Response对象，不需要经过后面的业务handler。</p>
</li>
<li>
<p>用于处理业务逻辑的handler。</p>
</li>
<li>
<p>设置boss线程组的socket参数。</p>
</li>
<li>
<p>设置worker线程组的socket参数。</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_消息编码与解码">2.2. 消息编码与解码</h3>
<div class="paragraph">
<p>Netty通过实现 <code>ChannelOutboundHandler</code> 接口的 <code>write</code> 方法来处理消息编码，但为了简化 <code>ByteBuf</code> 的内存分配和释放操作，我们通常继承 <code>MessageToByteEncoder</code> 来处理消息的序列化。但除了序列化，我们还需要考虑TCP发送的时候，由于缓存区大小、MSS、MTU等因素导致的粘包拆包问题，最通用的解决办法就是使用定长消息头，并在其中包含消息体的长度信息。这样解码的时候就可以先读取一个定长字节，然后根据长度信息对消息体解码。</p>
</div>
<div class="listingblock">
<div class="title">RequestEncoder</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class RequestEncoder extends MessageToByteEncoder&lt;RpcRequest&gt; {
    private final Charset charset = Charset.forName("UTF-8");
    private Gson gson = new Gson();

    @Override
    protected void encode(ChannelHandlerContext ctx, RpcRequest msg, ByteBuf out) throws Exception {
        String json = gson.toJson(msg);
        out.writeInt(json.length());  <b class="conum">(1)</b>
        out.writeCharSequence(json, charset);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>写入消息体长度。Netty提供了 <a href="https://netty.io/4.1/api/io/netty/handler/codec/LengthFieldPrepender.html">LengthFieldPrepender</a> 帮我们自动添加 length 域到header里面，但这里为简化起见，直接调用 <code>writeInt</code> 写入长度。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>对于带有长度信息的消息解码，可以利用 <a href="https://netty.io/4.1/api/io/netty/handler/codec/LengthFieldBasedFrameDecoder.html">LengthFieldBasedFrameDecoder</a> 处理粘包拆包。但我们的封包格式非常简单，这里就直接读取了。我们使用了 <code>ReplayingDecoder</code> 来简化读取过程，<code>ReplayingDecoder</code> 会在读取指定长度的内容前调用 <code>buf.readableBytes()</code> 检查剩余字节，如果不满足则重置 readerIndex，等待下次读取。当然 <code>ReplayingDecoder</code> 这种做法在慢速网络里容易引发反复读取的性能问题，我们暂时不考虑这点。同时由于长度一定是正整数，我们还可以利用负数当 keep alive 的消息包，例如下面读到 -1 后直接回个 -1。</p>
</div>
<div class="listingblock">
<div class="title">RequestDecoder</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class RequestDecoder extends ReplayingDecoder&lt;RpcRequest&gt; {
    private final Charset charset = Charset.forName("UTF-8");
    private Gson gson = new Gson();

    @Override
    protected void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception {
        int strLen = in.readInt();
        if (strLen == -1) {
            ctx.writeAndFlush(ctx.alloc().buffer(4).writeInt(-1));
            return;
        }
        RpcRequest request = gson.fromJson(in.readCharSequence(strLen, charset).toString(), RpcRequest.class);
        out.add(request);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_异常处理">2.3. 异常处理</h3>
<div class="paragraph">
<p>Netty中的异常处理也是基于事件的，框架捕捉到异常后会触发异常事件，用户只需要在自己的 Handler 里面重写 <code>exceptionCaught</code> 方法，进行异常处理即可。异常也可以通过 <code>ctx.fireExceptionCaught(cause)</code> 传递给下一个 handler，这样可以方便统一处理异常。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause)
        throws Exception {
    log.info(cause.getLocalizedMessage(), cause);
    //do more exception handling
    ctx.close();
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_客户端应用">3. 客户端应用</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_client初始化">3.1. Client初始化</h3>
<div class="paragraph">
<p>客户端的初始化跟服务端类似，只是由 <code>bind</code> 变成了 <code>connect</code>，当然也不需要acceptor线程池。当连接建立之后我们会收到 <code>channelActive</code> 事件，对于可以立即初始化的操作，比如 Lightweight M2M bootstrap 消息我们可以在这里发送。但更常见的设计是将 Netty 的 handler 封装成协议层组件，由更上层的应用层逻辑控制消息收发。例如示例代码的 connect 和 send 操作。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public void connect(String host, int port) {
    EventLoopGroup workerGroup = new NioEventLoopGroup();
    Bootstrap b = new Bootstrap();
    b.group(workerGroup);
    b.channel(NioSocketChannel.class);
    b.option(ChannelOption.SO_KEEPALIVE, true);
    b.handler(new ChannelInitializer&lt;SocketChannel&gt;() {
        @Override
        public void initChannel(SocketChannel ch) throws Exception {
            ch.pipeline()
                .addLast("idleStateHandler", new IdleStateHandler(10, 5, 0))
                .addLast(new RequestEncoder(), new ResponseDecoder(),
                         new IdleHandler(), new ClientHandler());
        }
    });

    ChannelFuture f = b.connect(host, port).sync();  <b class="conum">(1)</b>
    this.channel = f.channel();  <b class="conum">(2)</b>
}

public void send(Request request) {
    channel.writeAndFlush(request);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>因为连接建立之前一般做不了什么，使用同步方式建立连接可以简化后续代码。</p>
</li>
<li>
<p>通常需要获取 channel 对象方便客户端主动发送消息。</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_事件处理">3.2. 事件处理</h3>
<div class="paragraph">
<p>除了用于收发消息的读写事件，用户事件也是非常常用的。例如上面客户端的代码我们使用了 <code>IdleStateHandler</code> 生成 idle 事件。<code>IdleStateHandler</code> 内部有个定时器计算读或写事件上分别有多长时间的 idle 状态，达到设定的时长后则调用 <code>ctx.fireUserEventTriggered(evt)</code> 发送 <code>IdleStateEvent</code>，后续 handler 通过重写 <code>userEventTriggered</code> 方法处理事件。例如下面代码我们收到 <code>READER_IDLE</code> 后主动发送一个 int 用于保持连接。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class IdleHandler extends ChannelDuplexHandler {
    @Override
    public void userEventTriggered(ChannelHandlerContext ctx, Object evt)
            throws Exception {
        if (evt instanceof IdleStateEvent) {
            IdleStateEvent e = (IdleStateEvent) evt;
            if (e.state() == IdleState.READER_IDLE) {
                ctx.writeAndFlush(ctx.alloc().buffer(4).writeInt(-1));
            } else if (e.state() == IdleState.WRITER_IDLE) {
                //do nothing
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_内部机制">4. 内部机制</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_线程模型">4.1. 线程模型</h3>
<div class="paragraph">
<p>在 Netty 中每个 Channel 创建的时候都会被 EventLoopGroup 以 round robin 策略分配给一个 EventLoop，并保证在 Channel 的整个生命周期都由这个 EventLoop 处理上面的事件。而 EventLoop 背后则是一个线程，与线程一对一绑定。EventLoop 不断的监听网络事件，并将事件分发给 ChannelHandler。ChannelHandler 的执行也是在当前 EventLoop 线程中，一旦 handler 中的处理出现了阻塞，会导致一组 Channel 无法及时处理。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPgo8IS0tIEdlbmVyYXRlZCBieSBncmFwaHZpeiB2ZXJzaW9uIDIuMzguMCAoMjAxNDA0MTMuMjA0MSkKIC0tPgo8IS0tIFRpdGxlOiB0aHJlYWRfbW9kZWwgUGFnZXM6IDEgLS0+Cjxzdmcgd2lkdGg9IjY5MHB0IiBoZWlnaHQ9IjI5MnB0Igogdmlld0JveD0iMC4wMCAwLjAwIDY5MC4xNiAyOTIuMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPgo8ZyBpZD0iZ3JhcGgwIiBjbGFzcz0iZ3JhcGgiIHRyYW5zZm9ybT0ic2NhbGUoMSAxKSByb3RhdGUoMCkgdHJhbnNsYXRlKDQgMjg4KSI+Cjx0aXRsZT50aHJlYWRfbW9kZWw8L3RpdGxlPgo8cG9seWdvbiBmaWxsPSJ3aGl0ZSIgc3Ryb2tlPSJub25lIiBwb2ludHM9Ii00LDQgLTQsLTI4OCA2ODYuMTYxLC0yODggNjg2LjE2MSw0IC00LDQiLz4KPCEtLSBHVCAtLT4KPGcgaWQ9Im5vZGUxIiBjbGFzcz0ibm9kZSI+PHRpdGxlPkdUPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9InN0YXJ0IiB4PSIzMC4wODA3IiB5PSItMjY4LjgiIGZvbnQtZmFtaWx5PSJLYWlHZW4gR290aGljIENOLE1pY3Jvc29mdCBZYUhlaSxBcmlhbCxzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0LjAwIj7miYDmnInnmoRFdmVudExvb3Dpg73nlLE8L3RleHQ+Cjx0ZXh0IHRleHQtYW5jaG9yPSJzdGFydCIgeD0iMzAuMDgwNyIgeT0iLTI1My44IiBmb250LWZhbWlseT0iS2FpR2VuIEdvdGhpYyBDTixNaWNyb3NvZnQgWWFIZWksQXJpYWwsc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+6L+Z5LiqRXZlbnRMb29wR3JvdXA8L3RleHQ+Cjx0ZXh0IHRleHQtYW5jaG9yPSJzdGFydCIgeD0iMzAuMDgwNyIgeT0iLTIzOC44IiBmb250LWZhbWlseT0iS2FpR2VuIEdvdGhpYyBDTixNaWNyb3NvZnQgWWFIZWksQXJpYWwsc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+5YiG6YWN77yM5pyJM+S4quato+WcqOS9v+eUqDwvdGV4dD4KPHRleHQgdGV4dC1hbmNob3I9InN0YXJ0IiB4PSIzMC4wODA3IiB5PSItMjIzLjgiIGZvbnQtZmFtaWx5PSJLYWlHZW4gR290aGljIENOLE1pY3Jvc29mdCBZYUhlaSxBcmlhbCxzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0LjAwIj7nmoRFdmVudExvb3A8L3RleHQ+CjwvZz4KPCEtLSBFVCAtLT4KPGcgaWQ9Im5vZGUyIiBjbGFzcz0ibm9kZSI+PHRpdGxlPkVUPC90aXRsZT4KPHRleHQgdGV4dC1hbmNob3I9InN0YXJ0IiB4PSIyMzkuMTYxIiB5PSItMjY4LjgiIGZvbnQtZmFtaWx5PSJLYWlHZW4gR290aGljIENOLE1pY3Jvc29mdCBZYUhlaSxBcmlhbCxzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0LjAwIj7mr4/kuKpFdmVudExvb3DlsIblpITnkIbliIbphY3nu5k8L3RleHQ+Cjx0ZXh0IHRleHQtYW5jaG9yPSJzdGFydCIgeD0iMjM5LjE2MSIgeT0iLTI1My44IiBmb250LWZhbWlseT0iS2FpR2VuIEdvdGhpYyBDTixNaWNyb3NvZnQgWWFIZWksQXJpYWwsc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+5a6D55qE5omA5pyJQ2hhbm5lbOeahOaJgOacieS6i+S7tjwvdGV4dD4KPHRleHQgdGV4dC1hbmNob3I9InN0YXJ0IiB4PSIyMzkuMTYxIiB5PSItMjM4LjgiIGZvbnQtZmFtaWx5PSJLYWlHZW4gR290aGljIENOLE1pY3Jvc29mdCBZYUhlaSxBcmlhbCxzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0LjAwIj7lkozku7vliqHjgILmr4/kuKpFdmVudExvb3Dpg73lkow8L3RleHQ+Cjx0ZXh0IHRleHQtYW5jaG9yPSJzdGFydCIgeD0iMjM5LjE2MSIgeT0iLTIyMy44IiBmb250LWZhbWlseT0iS2FpR2VuIEdvdGhpYyBDTixNaWNyb3NvZnQgWWFIZWksQXJpYWwsc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+5LiA5LiqVGhyZWFk55u45YWz6IGUPC90ZXh0Pgo8L2c+CjwhLS0gR1QmIzQ1OyYjNDU7RVQgLS0+CjwhLS0gbG9vcEcgLS0+CjxnIGlkPSJub2RlNCIgY2xhc3M9Im5vZGUiPjx0aXRsZT5sb29wRzwvdGl0bGU+CjxlbGxpcHNlIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGN4PSI5Ny41ODA3IiBjeT0iLTcyIiByeD0iOTcuNjYxNSIgcnk9IjI2Ljc0MDciLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iOTcuNTgwNyIgeT0iLTc1LjgiIGZvbnQtZmFtaWx5PSJLYWlHZW4gR290aGljIENOLE1pY3Jvc29mdCBZYUhlaSxBcmlhbCxzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0LjAwIj7lhbfmnIkz5LiqRXZlbnRMb29wPC90ZXh0Pgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI5Ny41ODA3IiB5PSItNjAuOCIgZm9udC1mYW1pbHk9IkthaUdlbiBHb3RoaWMgQ04sTWljcm9zb2Z0IFlhSGVpLEFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPueahEV2ZW50TG9vcEdyb3VwPC90ZXh0Pgo8L2c+CjwhLS0gR1QmIzQ1OyYjNDU7bG9vcEcgLS0+CjxnIGlkPSJlZGdlNCIgY2xhc3M9ImVkZ2UiPjx0aXRsZT5HVCYjNDU7JiM0NTtsb29wRzwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik05Ny41ODA3LC0yMTUuODE2Qzk3LjU4MDcsLTE4MC4yNTkgOTcuNTgwNywtMTQ0LjcwMyA5Ny41ODA3LC0xMDkuMTQ2Ii8+Cjxwb2x5Z29uIGZpbGw9ImJsYWNrIiBzdHJva2U9ImJsYWNrIiBwb2ludHM9IjEwMS4wODEsLTEwOS4xMTcgOTcuNTgwNywtOTkuMTE3MiA5NC4wODA4LC0xMDkuMTE3IDEwMS4wODEsLTEwOS4xMTciLz4KPC9nPgo8IS0tIENUIC0tPgo8ZyBpZD0ibm9kZTMiIGNsYXNzPSJub2RlIj48dGl0bGU+Q1Q8L3RpdGxlPgo8dGV4dCB0ZXh0LWFuY2hvcj0ic3RhcnQiIHg9IjQ2My4xNjEiIHk9Ii0yNjguOCIgZm9udC1mYW1pbHk9IkthaUdlbiBHb3RoaWMgQ04sTWljcm9zb2Z0IFlhSGVpLEFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPkV2ZW50TG9vcEdyb3Vw5bCG5Li65q+P5Liq5paw5Yib5bu655qEPC90ZXh0Pgo8dGV4dCB0ZXh0LWFuY2hvcj0ic3RhcnQiIHg9IjQ2My4xNjEiIHk9Ii0yNTMuOCIgZm9udC1mYW1pbHk9IkthaUdlbiBHb3RoaWMgQ04sTWljcm9zb2Z0IFlhSGVpLEFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPkNoYW5uZWzliIbphY3kuIDkuKpFdmVudExvb3DjgILlnKjmr488L3RleHQ+Cjx0ZXh0IHRleHQtYW5jaG9yPSJzdGFydCIgeD0iNDYzLjE2MSIgeT0iLTIzOC44IiBmb250LWZhbWlseT0iS2FpR2VuIEdvdGhpYyBDTixNaWNyb3NvZnQgWWFIZWksQXJpYWwsc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+5LiqQ2hhbm5lbOeahOaVtOS4queUn+WRveWRqOacn+WGhe+8jOaJgOaciTwvdGV4dD4KPHRleHQgdGV4dC1hbmNob3I9InN0YXJ0IiB4PSI0NjMuMTYxIiB5PSItMjIzLjgiIGZvbnQtZmFtaWx5PSJLYWlHZW4gR290aGljIENOLE1pY3Jvc29mdCBZYUhlaSxBcmlhbCxzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0LjAwIj7nmoTmk43kvZzpg73lsIbnlLHnm7jlkIznmoRUaHJlYWTmiafooYw8L3RleHQ+CjwvZz4KPCEtLSBFVCYjNDU7JiM0NTtDVCAtLT4KPCEtLSBlMSAtLT4KPGcgaWQ9Im5vZGU1IiBjbGFzcz0ibm9kZSI+PHRpdGxlPmUxPC90aXRsZT4KPGVsbGlwc2UgZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgY3g9IjMyNS4xNjEiIGN5PSItMTI2IiByeD0iNTUuNzkwMyIgcnk9IjE4Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjMyNS4xNjEiIHk9Ii0xMjIuMyIgZm9udC1mYW1pbHk9IkthaUdlbiBHb3RoaWMgQ04sTWljcm9zb2Z0IFlhSGVpLEFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPkV2ZW50TG9vcDwvdGV4dD4KPC9nPgo8IS0tIEVUJiM0NTsmIzQ1O2UxIC0tPgo8ZyBpZD0iZWRnZTUiIGNsYXNzPSJlZGdlIj48dGl0bGU+RVQmIzQ1OyYjNDU7ZTE8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNMzI1LjE2MSwtMjE1Ljc2NUMzMjUuMTYxLC0xOTUuMzIzIDMyNS4xNjEsLTE3NC44ODIgMzI1LjE2MSwtMTU0LjQ0MSIvPgo8cG9seWdvbiBmaWxsPSJibGFjayIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSIzMjguNjYyLC0xNTQuNDA2IDMyNS4xNjEsLTE0NC40MDYgMzIxLjY2MiwtMTU0LjQwNiAzMjguNjYyLC0xNTQuNDA2Ii8+CjwvZz4KPCEtLSBjMSAtLT4KPGcgaWQ9Im5vZGU4IiBjbGFzcz0ibm9kZSI+PHRpdGxlPmMxPC90aXRsZT4KPGVsbGlwc2UgZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgY3g9IjU2OC42NjEiIGN5PSItMTgwIiByeD0iNDQuMzkzIiByeT0iMTgiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iNTY4LjY2MSIgeT0iLTE3Ni4zIiBmb250LWZhbWlseT0iS2FpR2VuIEdvdGhpYyBDTixNaWNyb3NvZnQgWWFIZWksQXJpYWwsc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+Q2hhbm5lbDwvdGV4dD4KPC9nPgo8IS0tIENUJiM0NTsmIzQ1O2MxIC0tPgo8ZyBpZD0iZWRnZTMiIGNsYXNzPSJlZGdlIj48dGl0bGU+Q1QmIzQ1OyYjNDU7YzE8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNNTY4LjY2MSwtMjE1LjkwNkM1NjguNjYxLC0yMTMuMzAxIDU2OC42NjEsLTIxMC42OTcgNTY4LjY2MSwtMjA4LjA5MiIvPgo8cG9seWdvbiBmaWxsPSJibGFjayIgc3Ryb2tlPSJibGFjayIgcG9pbnRzPSI1NzIuMTYyLC0yMDguMDQ3IDU2OC42NjEsLTE5OC4wNDcgNTY1LjE2MiwtMjA4LjA0NyA1NzIuMTYyLC0yMDguMDQ3Ii8+CjwvZz4KPCEtLSBsb29wRyYjNDU7JiM0NTtlMSAtLT4KPGcgaWQ9ImVkZ2U2IiBjbGFzcz0iZWRnZSI+PHRpdGxlPmxvb3BHJiM0NTsmIzQ1O2UxPC90aXRsZT4KPHBhdGggZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgZD0iTTE3MS44MiwtODkuNTMyM0MyMDcuNDU2LC05OC4wNjI4IDI0OS4xMjMsLTEwOC4wMzcgMjc5Ljg2NCwtMTE1LjM5NiIvPgo8L2c+CjwhLS0gZTIgLS0+CjxnIGlkPSJub2RlNiIgY2xhc3M9Im5vZGUiPjx0aXRsZT5lMjwvdGl0bGU+CjxlbGxpcHNlIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGN4PSIzMjUuMTYxIiBjeT0iLTcyIiByeD0iNTUuNzkwMyIgcnk9IjE4Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjMyNS4xNjEiIHk9Ii02OC4zIiBmb250LWZhbWlseT0iS2FpR2VuIEdvdGhpYyBDTixNaWNyb3NvZnQgWWFIZWksQXJpYWwsc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+RXZlbnRMb29wPC90ZXh0Pgo8L2c+CjwhLS0gbG9vcEcmIzQ1OyYjNDU7ZTIgLS0+CjxnIGlkPSJlZGdlNyIgY2xhc3M9ImVkZ2UiPjx0aXRsZT5sb29wRyYjNDU7JiM0NTtlMjwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik0xOTUuMjI5LC03MkMyMjAuNDYxLC03MiAyNDYuNzkzLC03MiAyNjkuMDM0LC03MiIvPgo8L2c+CjwhLS0gZTMgLS0+CjxnIGlkPSJub2RlNyIgY2xhc3M9Im5vZGUiPjx0aXRsZT5lMzwvdGl0bGU+CjxlbGxpcHNlIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGN4PSIzMjUuMTYxIiBjeT0iLTE4IiByeD0iNTUuNzkwMyIgcnk9IjE4Ii8+Cjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjMyNS4xNjEiIHk9Ii0xNC4zIiBmb250LWZhbWlseT0iS2FpR2VuIEdvdGhpYyBDTixNaWNyb3NvZnQgWWFIZWksQXJpYWwsc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNC4wMCI+RXZlbnRMb29wPC90ZXh0Pgo8L2c+CjwhLS0gbG9vcEcmIzQ1OyYjNDU7ZTMgLS0+CjxnIGlkPSJlZGdlOCIgY2xhc3M9ImVkZ2UiPjx0aXRsZT5sb29wRyYjNDU7JiM0NTtlMzwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik0xNzEuODIsLTU0LjQ2NzdDMjA3LjQ1NiwtNDUuOTM3MiAyNDkuMTIzLC0zNS45NjI5IDI3OS44NjQsLTI4LjYwNCIvPgo8L2c+CjwhLS0gZTEmIzQ1OyYjNDU7YzEgLS0+CjxnIGlkPSJlZGdlOSIgY2xhc3M9ImVkZ2UiPjx0aXRsZT5lMSYjNDU7JiM0NTtjMTwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik0zNzEuNTg2LC0xMzYuMTU3QzQxNy4yMjIsLTE0Ni4zNjEgNDg2Ljc1NywtMTYxLjkxIDUyOS41OTEsLTE3MS40ODciLz4KPC9nPgo8IS0tIGMyIC0tPgo8ZyBpZD0ibm9kZTkiIGNsYXNzPSJub2RlIj48dGl0bGU+YzI8L3RpdGxlPgo8ZWxsaXBzZSBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBjeD0iNTY4LjY2MSIgY3k9Ii0xMjYiIHJ4PSI0NC4zOTMiIHJ5PSIxOCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI1NjguNjYxIiB5PSItMTIyLjMiIGZvbnQtZmFtaWx5PSJLYWlHZW4gR290aGljIENOLE1pY3Jvc29mdCBZYUhlaSxBcmlhbCxzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5DaGFubmVsPC90ZXh0Pgo8L2c+CjwhLS0gZTEmIzQ1OyYjNDU7YzIgLS0+CjxnIGlkPSJlZGdlMTAiIGNsYXNzPSJlZGdlIj48dGl0bGU+ZTEmIzQ1OyYjNDU7YzI8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNMzgxLjI2NCwtMTI2QzQyNC42OTgsLTEyNiA0ODQuNDEzLC0xMjYgNTI0LjQzOCwtMTI2Ii8+CjwvZz4KPCEtLSBjMyAtLT4KPGcgaWQ9Im5vZGUxMCIgY2xhc3M9Im5vZGUiPjx0aXRsZT5jMzwvdGl0bGU+CjxlbGxpcHNlIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGN4PSI1NjguNjYxIiBjeT0iLTcyIiByeD0iNDQuMzkzIiByeT0iMTgiLz4KPHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iNTY4LjY2MSIgeT0iLTY4LjMiIGZvbnQtZmFtaWx5PSJLYWlHZW4gR290aGljIENOLE1pY3Jvc29mdCBZYUhlaSxBcmlhbCxzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0LjAwIj5DaGFubmVsPC90ZXh0Pgo8L2c+CjwhLS0gZTImIzQ1OyYjNDU7YzMgLS0+CjxnIGlkPSJlZGdlMTEiIGNsYXNzPSJlZGdlIj48dGl0bGU+ZTImIzQ1OyYjNDU7YzM8L3RpdGxlPgo8cGF0aCBmaWxsPSJub25lIiBzdHJva2U9ImJsYWNrIiBkPSJNMzgxLjI2NCwtNzJDNDI0LjY5OCwtNzIgNDg0LjQxMywtNzIgNTI0LjQzOCwtNzIiLz4KPC9nPgo8IS0tIGM0IC0tPgo8ZyBpZD0ibm9kZTExIiBjbGFzcz0ibm9kZSI+PHRpdGxlPmM0PC90aXRsZT4KPGVsbGlwc2UgZmlsbD0ibm9uZSIgc3Ryb2tlPSJibGFjayIgY3g9IjU2OC42NjEiIGN5PSItMTgiIHJ4PSI0NC4zOTMiIHJ5PSIxOCIvPgo8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI1NjguNjYxIiB5PSItMTQuMyIgZm9udC1mYW1pbHk9IkthaUdlbiBHb3RoaWMgQ04sTWljcm9zb2Z0IFlhSGVpLEFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQuMDAiPkNoYW5uZWw8L3RleHQ+CjwvZz4KPCEtLSBlMyYjNDU7JiM0NTtjNCAtLT4KPGcgaWQ9ImVkZ2UxMiIgY2xhc3M9ImVkZ2UiPjx0aXRsZT5lMyYjNDU7JiM0NTtjNDwvdGl0bGU+CjxwYXRoIGZpbGw9Im5vbmUiIHN0cm9rZT0iYmxhY2siIGQ9Ik0zODEuMjY0LC0xOEM0MjQuNjk4LC0xOCA0ODQuNDEzLC0xOCA1MjQuNDM4LC0xOCIvPgo8L2c+CjwvZz4KPC9zdmc+Cg==" alt=""/>
</div>
<div class="title">Figure 2. EventLoop分配模型，摘自 <a href="https://www.jianshu.com/p/95513325d439" class="bare">https://www.jianshu.com/p/95513325d439</a></div>
</div>
<div class="paragraph">
<p>从上图的分配模型我们也可以很容易的看出，Netty被设计为使用少数线程处理大量 Channel，如果业务的连接数较少，将无法充分发挥服务器性能。</p>
</div>
</div>
<div class="sect2">
<h3 id="_bytebuf">4.2. ByteBuf</h3>
<div class="paragraph">
<p>上面的例子我们看到最终从channel里面读写的都是ByteBuf对象，ByteBuf 是最值得注意的类型, 它利用引用计数来提高内存分配和释放的性能。相对JVM的GC算法，单纯的引用计数性能要好得多，但同时它也容易引起内存泄漏。这里我们看看Netty是如何管理引用计数，以及我们在编码中需要注意的事项。</p>
</div>
<div class="paragraph">
<p>ByteBuf 在初次分配的时候，引用计数为 <code>1</code>，当我们读完 ByteBuf 之后应调用 release() 方法，将引用计数减一，以便netty可以回收该ByteBuf使用的内存段。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ByteBuf buf = ctx.alloc().directBuffer();
assert buf.refCnt() == 1;
boolean destroyed = buf.release();
assert destroyed;
assert buf.refCnt() == 0;</code></pre>
</div>
</div>
<div class="paragraph">
<p>但在前面Decoder的例子中，我们并没有手工release，这会导致内存泄漏吗？通过阅读 <a href="https://netty.io/4.0/xref/io/netty/handler/codec/ByteToMessageDecoder.html#256">ByteToMessageDecoder.channelRead()</a> 方法的源码，可以发现 ByteToMessageDecoder 已经帮我们做了 release，无需我们再手工管理。但如果是自行实现 channelRead()  接口，则必须考虑 ByteBuf 的 release。关于引用计数更详细的说明可以参考官方wiki <a href="https://netty.io/wiki/reference-counted-objects.html">Reference counted objects</a>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_native_epoll">4.3. Native epoll</h3>
<div class="paragraph">
<p>Netty 的 epoll 传输层使用了 epoll 边界触发模式(edge-triggered), 这比 Java NIO 提供的水平触发模式(level-triggered) 可能有更好的性能。同时它支持NIO不支持一些选项，例如 TCP_CORK, SO_REUSEPORT 等等。</p>
</div>
<div class="paragraph">
<p>Netty 中我们只需要简单判断下当前系统是否支持 Epoll 即可将 EventLoopGroup 和 channelClass 切换到 Epoll 版本上。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">EventLoopGroup bossGroup = Epoll.isAvailable() ? new EpollEventLoopGroup() : new NioEventLoopGroup();
new ServerBootstrap().group(bossGroup, bossGroup)
    .channel(Epoll.isAvailable() ? EpollServerSocketChannel.class : NioServerSocketChannel.class);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_参考">参考</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a href="https://www.baeldung.com/netty" class="bare">https://www.baeldung.com/netty</a></p>
</li>
<li>
<p><a href="https://netty.io/wiki/reference-counted-objects.html" class="bare">https://netty.io/wiki/reference-counted-objects.html</a></p>
</li>
<li>
<p><a href="http://imwyy.xyz/2018/06/19/netty%E9%AB%98%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/">http://imwyy.xyz/2018/06/19/netty高性能调优</a></p>
</li>
<li>
<p><a href="https://www.jianshu.com/p/95513325d439" class="bare">https://www.jianshu.com/p/95513325d439</a></p>
</li>
<li>
<p><a href="https://programmer.help/blogs/netty-implements-synchronous-request-response-communication-mechanism.html" class="bare">https://programmer.help/blogs/netty-implements-synchronous-request-response-communication-mechanism.html</a></p>
</li>
<li>
<p><a href="https://netty.io/wiki/reference-counted-objects.html" class="bare">https://netty.io/wiki/reference-counted-objects.html</a> <a href="https://emacsist.github.io/2018/04/28/%E7%BF%BB%E8%AF%91netty%E4%B8%AD%E7%9A%84%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E5%AF%B9%E8%B1%A1/">中文翻译</a></p>
</li>
<li>
<p><a href="http://normanmaurer.me/presentations/2014-facebook-eng-netty/slides.html" class="bare">http://normanmaurer.me/presentations/2014-facebook-eng-netty/slides.html</a></p>
</li>
</ul>
</div>
</div>
</div>
    </article>
    <section class="comment">
        <div id="disqus_thread"></div>
    </section>
</section>
<footer class="footer">
    Copyright © 2020 | Powered by <a href="https://github.com/chenhm/java-static-blog" target="_blank">java-static-blog</a>
</footer>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-core.min.js" integrity="sha256-Y+Budm2wBEjYjbH0qcJRmLuRBFpXd0VKxl6XhdS4hgA=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/plugins/keep-markup/prism-keep-markup.min.js" integrity="sha256-jHeLW+quLKoSpBFisYif0SQf9Z20AKgmKb2vcdWehJI=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/plugins/autoloader/prism-autoloader.min.js" integrity="sha256-ht8ay6ZTPZfuixYB99I5oRpCLsCq7Do2LjEYLwbe+X8=" crossorigin="anonymous"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-39495276-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-39495276-1');
</script>

</body>
</html>