<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, user-scalable=no"/>
    <meta name="renderer" content="webkit"/>
    <meta name="theme-color" content="#ffffff"/>
    <link rel="manifest" href="/manifest.json"/>
    <link href="/static/asciidoctor.min.css" rel="stylesheet"/>
    <link href="/static/build.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/themes/prism.min.css" integrity="sha256-77qGXu2p8NpfcBpTjw4jsMeQnz0vyh74f5do0cWjQ/Q=" crossorigin="anonymous" />
</head>
<body>
<div id='app'>
    <header class="header">
        <div class="container">
            <!--start: Navigation -->
            <a href="/" class="brand">On the Road</a>
<!--            <ul class="nav">-->
<!--                <li><a href="/list/">Blogs</a></li>-->
<!--                <li><a href="/slides/">Slides</a></li>-->
<!--                <li><a href="/about/">About</a></li>-->
<!--            </ul>-->
        </div>
        <!--end: Navigation -->
        <div style="clear: both"></div>
        <search-bar v-if="isPageList"></search-bar>
    </header>

<section class="post-view">
    <article>
     
         <h1 class="post-title">             使用apf和fail2ban保护Linux         </h1>
     
     <p>部署在公网上的服务器随时都会受到各种攻击，我们可以使用apf做网络防火墙，配合fail2ban防止ssh暴力破解。</p>
<ol>
<li>APF的安装配置</li>
</ol>
<hr />
<p>APF本身只是一些脚本，通过一些简单的规则自动配置iptables，实现防火墙功能，安装上非常简单。</p>
<pre><code>wget http://www.rfxnetworks.com/downloads/apf-current.tar.gz
tar -xvzf apf-current.tar.gz
cd apf-*
./install.sh
</code></pre>
<p>安装成功后会显示当前监听端口的情况。下面修改apf的配置文件<code>vi /etc/apf/conf.apf</code></p>
<pre><code>IFACE_IN=&quot;eth1&quot;                    #设置过滤的网络接口
IFACE_OUT=&quot;eth1&quot;                   #一般跟IFACE_IN相同
IG_TCP_CPORTS=&quot;22,80,443,3306&quot;     #设置服务器允许被访问的TCP端口
IG_UDP_CPORTS=&quot;53&quot;                 #设置服务器允许被访问的UDP端口
EGF=&quot;1&quot;                            #开启出站过滤
EG_TCP_CPORTS=&quot;21,25,80,443,43&quot;    #设置服务器允许对外访问的TCP端口
EG_UDP_CPORTS=&quot;20,21,53&quot;           #设置服务器允许对外访问的UDP端口  

DEVEL_MODE=&quot;0&quot; #当验证配置无问题后修改此参数值为0，值为1时apf会在5分钟后自动回滚配置
</code></pre>
<p>如果只允许特定主机访问，可以如下配置：</p>
<pre><code>//在/etc/apf/allow_hosts.rules添加如下信息
tcp:in:d=22:s=1.2.3.4
out:d=22:d=1.2.3.4

//在/etc/apf/deny_hosts.rules添加如下信息
tcp:in:d=22:s=0/0
out:d=22:d=0/0
</code></pre>
<p>最后重启apf防火墙 <code>apf -r</code>，直接输入<code>apf</code>可以看到使用帮助。</p>
<ol>
<li>fail2ban的安装配置</li>
</ol>
<hr />
<p>fail2ban的安装也很简单，debian下直接<code>apt-get install fail2ban</code>即可。安装好之后可以在<code>/etc/fail2ban/filter.d</code>看到用于匹配各种服务日志的规则。<br />
修改fail2ban的主配置文件<code>vi /etc/fail2ban/jail.conf</code></p>
<pre><code>[DEFAULT]       #全局配置信息
bantime  = 600  #默认屏蔽时间
maxretry = 3    #默认3次失败后屏蔽

[ssh]
enabled = true  #ssh防护是默认启动的
port    = ssh
filter  = sshd
logpath  = /var/log/auth.log
maxretry = 6    #根据需要修改失败屏蔽次数
</code></pre>
<p>根据需要启动保护的服务，然后重启fail2ban：</p>
<pre><code>service fail2ban restart
</code></pre>
<p>最后验证fail2ban是否运行正常：</p>
<pre><code>fail2ban-client status
</code></pre>

    </article>
    <section class="comment">
        <div id="disqus_thread"></div>
    </section>
</section>
<footer class="footer">
    Copyright © 2020 | Powered by <a href="https://github.com/chenhm/java-static-blog" target="_blank">java-static-blog</a>
</footer>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-core.min.js" integrity="sha256-Y+Budm2wBEjYjbH0qcJRmLuRBFpXd0VKxl6XhdS4hgA=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/plugins/autoloader/prism-autoloader.min.js" integrity="sha256-ht8ay6ZTPZfuixYB99I5oRpCLsCq7Do2LjEYLwbe+X8=" crossorigin="anonymous"></script>
</body>
</html>